
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Anjuke Engineering</title>
  <meta name="author" content="Anjuke Inc.">

  
  <meta name="description" content="这里介绍一下 system 和 system-ext 里的一些设计原则。 本文需要对常见的设计模式有一个基本的了解，如果你对设计模式还一无所知，推荐阅读 Head First Design Pattern 免责声明！！下面的内容都是我个人的总结，难免有错误的地方。主要是希望能抛砖引玉， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://arch.corp.anjuke.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Anjuke Engineering" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38932031-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Anjuke Engineering</a></h1>
  
    <h2>技术成就梦想</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:arch.corp.anjuke.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/anjuke">Code</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/13/v2-and-desigin-pattern/">V2 中的软件设计</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-13T11:30:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/kdlan"><img class="right" src="https://avatars1.githubusercontent.com/u/863872?s=460" width="80"></a></p>

<p>这里介绍一下 <a href="http://git.corp.anjuke.com/corp/v2-system">system</a> 和 <a href="http://git.corp.anjuke.com/site/system-ext">system-ext</a> 里的一些设计原则。</p>

<p>本文需要对常见的设计模式有一个基本的了解，如果你对设计模式还一无所知，推荐阅读 <a href="http://www.amazon.cn/Head-First%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%BC%97%E9%87%8C%E6%9B%BC/dp/B0011FBU34"><em>Head First Design Pattern</em></a></p>

<p><strong>免责声明！！下面的内容都是我个人的总结，难免有错误的地方。主要是希望能抛砖引玉，大家能有自己的思考就好了</strong></p>

<h2>1. 软件设计的一些原则</h2>

<p>参考</p>

<ul>
<li><a href="http://coolshell.cn/articles/4535.html">一些软件设计的原则</a></li>
<li><a href="http://www.cnblogs.com/ldcsaa/archive/2012/02/26/2368959.html">软件实体的设计原则</a></li>
<li><a href="http://www.amazon.cn/Head-First%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%BC%97%E9%87%8C%E6%9B%BC/dp/B0011FBU34">Head First Design Pattern</a></li>
</ul>


<p>这里偷个懒，给了一堆链接先参考一下，只提一些比较常见而且容易做到的原则。</p>

<h3>1.1 职责单一原则</h3>

<p><strong>Single Responsibility Principle (SRP)</strong></p>

<p>单一职责是说的一个类，一个方法只做一件事情。比如有用户注册，用户注册以后需要发邮件这样两个动作。那么遵守单一职责，需要将注册的逻辑放到一个类里，发送邮件的逻辑应该在另外一个类似，而不是合在同一段代码之中。</p>

<p>通过单一职责原则，可以比较容易的做到代码的高内聚低耦合。</p>

<h3>1.2 开闭原则</h3>

<p><strong>Open/Closed Principle (OCP)</strong></p>

<p>即对扩展开放，对修改关闭。V2 的核心代码对于这个原则有非常好的体现。比如我们要增加 URL 的处理逻辑，只需要写对应的 Controller 和 router 配置就行了，无需对 V2 进行修改。另外如果我们需要在 Router/Request/Response 对象上添加额外的行为，也只需要修改 V2 的配置，对于 V2 本身的代码是不需要修改的。</p>

<p>这样做的好处在于，对于核心的代码（对 V2 来说就是 APF），无论业务/需求如何变化，基本上不需要去修改这段代码（修 bug 除外），这样也可以比较容易的做到代码的高内聚。</p>

<h3>1.3 最少知识原则</h3>

<p><strong>Principle of Least Knowledge</strong></p>

<p>简单来说就是调用方对于被调用放无需知道太多的内容，只用了解最基本的 API 就行了。比如这段代码，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">String</span> <span class="n">outputDir</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">.</span><span class="na">getOptions</span><span class="o">()</span>
</span><span class='line'>        <span class="o">.</span><span class="na">getScratchDir</span><span class="o">()</span>
</span><span class='line'>        <span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码本身作为调用方，需要了解 ctxt.getOptions() 返回了什么内容，还要知道 options.getScratchDir() 返回什么内容，更进一步才能拿到想要的 absolutePath。</p>

<p>如果这样写</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="n">String</span> <span class="n">outputDir</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">.</span><span class="na">getScratchAbsolutePath</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>相对来说就不太需要关心 ctxt 的里面到底是些什么东西。</p>

<p>同样的，最少知识原则也是在提高代码的内聚上有帮助的。</p>

<h3>1.4 针对接口编程，而不是实现</h3>

<p><strong>Program to an interface, not an implementation</strong></p>

<p>注意这里的接口是 interface 而不是 API。简单来说就是使用类或者对象的时候，使用其接口，而不是具体的实现类。</p>

<p>比如 V2 的 APF 里，对于各个 Controller 都是使用的 <code>APF_Controller</code> 这个接口，调用它的 <code>handler_request</code> 方法，而不是直接使用我们自己定义的那些 Controller。</p>

<p>比如 CGI，也是一种接口，Apache、Nginx 调用 CGI 的模块，按照 CGI 的协议向后端发送请求。至于后面是 C++、PHP、Python、Java 都是一样的使用。违反这个原则的做法就是直接用 apache/nginx 去调用我们业务的 C++、PHP、Python、Java 代码。</p>

<h2>2. V2 的设计分析</h2>

<h3>2.1 <a href="http://git.corp.anjuke.com/corp/v2-system">system</a></h3>

<p>我们从 <a href="http://git.corp.anjuke.com/corp/v2-system/browse/master/classes/APF.php">APF.php</a> 开始，入口是 <code>APF::run()</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Error&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">prepare</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">apf_require_class</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_class</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">apf_require_class</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response_class</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request_class</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response_class</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">apf_require_class</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router_class</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router_class</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="nv">$router</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>prepare()</code> 这段代码里实际体现到了如何做到 OCP 和面向接口的原则，通过参数定义的 request_class、response_class、router_class 来使用具体的实现类。这样只要我们自己定义的 Request、Response、Router 实现了具体的抽象接口，就可以来扩展我们自己的行为，而不用去修改 V2 本身的代码了。</p>

<p>接下来是核心的 <code>dispatch</code> 方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">dispatch</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="na">mapping</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_controller</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$controller</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">current_controller</span> <span class="o">=</span> <span class="nv">$controller</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$interceptores</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_config</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s2">&quot;interceptor&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$interceptores</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$interceptor_classes</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_interceptor_classes</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$basic_class</span> <span class="o">=</span> <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">get_interceptor_index_name</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$interceptor_classes</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_interceptor_classes</span><span class="p">(</span><span class="nv">$basic_class</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$step</span> <span class="o">=</span> <span class="nx">APF_Interceptor</span><span class="o">::</span><span class="na">STEP_CONTINUE</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$interceptor_classes</span> <span class="k">as</span> <span class="nv">$interceptor_class</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$interceptor</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">load_interceptor</span><span class="p">(</span><span class="nv">$interceptor_class</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$interceptor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$interceptors</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$interceptor</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span><span class="s2">&quot;interceptor::before(): &quot;</span> <span class="o">.</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$interceptor</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$step</span> <span class="o">=</span> <span class="nv">$interceptor</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$step</span> <span class="o">!=</span> <span class="nx">APF_Interceptor</span><span class="o">::</span><span class="na">STEP_CONTINUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">is_debug_enabled</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">debug_config</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">trace_config</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$step</span> <span class="o">!=</span> <span class="nx">APF_Interceptor</span><span class="o">::</span><span class="na">STEP_EXIT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">handle_request</span><span class="p">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="nx">instanceof</span> <span class="nx">APF_Controller</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>                <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">class_exists</span><span class="p">(</span><span class="s1">&#39;APF_DB_Factory&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">APF_DB_Factory</span><span class="o">::</span><span class="na">get_instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">close_pdo_all</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">page</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$step</span> <span class="o">=</span> <span class="nx">APF_Interceptor</span><span class="o">::</span><span class="na">STEP_CONTINUE</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$interceptors</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$interceptors</span> <span class="o">=</span> <span class="nb">array_reverse</span><span class="p">(</span><span class="nv">$interceptors</span><span class="p">);</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$interceptors</span> <span class="k">as</span> <span class="nv">$interceptor</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$step</span> <span class="o">=</span> <span class="nv">$interceptor</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">debug</span><span class="p">(</span><span class="s2">&quot;interceptor::after(): &quot;</span> <span class="o">.</span> <span class="nb">get_class</span><span class="p">(</span><span class="nv">$interceptor</span><span class="p">));</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$step</span> <span class="o">!=</span> <span class="nx">APF_Interceptor</span><span class="o">::</span><span class="na">STEP_CONTINUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码比较长但是其实逻辑相对来说还是很清晰的</p>

<ul>
<li>调用 router->mapping() 获得 controller 对象</li>
<li>获取该 controller 上的 interceptor 对象</li>
<li>调用 interceptor->before()</li>
<li>调用 controller->handle_request()</li>
<li>调用 this->page() 处理 Page 逻辑</li>
<li>调用 interceptor->after()</li>
</ul>


<p>很明显，这里每一个对象都是通过接口的方式来使用的，这里的有 OCP 和面向接口两个原则体现。而为了实现这些原则，则是通过 router.php 和 interceptor.php 的配置文件来实现的</p>

<p>基本上 <code>APF-&gt;run()</code> 就是APF最核心的功能了，其余的都是 APF 提供的一些辅助方法（其实这些辅助方法应该放到别的地方去，因为违背了 <strong>单一职责</strong> 原则）。这里 APF 定义了最核心的处理逻辑，而一些具体的逻辑比如 URL mapping，比如具体每个 URL 的 handler_request 都交给了其他类来实现。同样 Router 只负责 URL mapping 一件事情，Controller 只负责 handle_request，Interceptor 只负责拦截 Controller 的处理，这里单一职责原则就体现出来了。<del>如果你和我一样对代码有洁癖就请无视APF的那些辅助方法吧</del></p>

<p>再来看看 Interceptor ，这里其实有一点点 <a href="https://zh.wikipedia.org/wiki/%E4%BA%8B%E4%BB%B6%E9%A9%85%E5%8B%95">事件驱动</a> 的味道。APF 定义了两个 Controller 的事件，<em>before handle_request</em> 和 <em>after handle_request</em> 两个事件，Interceptor 只不过是响应者两个事件的事件监听器而已。好处？最简单的，降低耦合度，提高代码重用。比如记录 Controller 的处理时间，如果没有 Interceptor，只能在每个 Controller 里加上时间记录的代码，如果要在每个 Controller 上都记录处理时间，则只能每个都增加代码，显然又违背了 <strong>单一职责</strong> 原则，而且有太多的重复代码，如果在 run 的代码里来做这件事情，又违背了 <strong>OCP</strong> 原则。</p>

<p>Router，在这里主要是负责做 <code>URL =&gt; controller</code> 的映射。直觉上，如果我们自己写一段这样的映射代码，可能就是大段的 if&#8230;else 来把各个 URL 分配到对应的 Controller 上（我真的见过几千行的 if&#8230;else 就是为了分发请求到对应的 Controller 上的）。大段的 if&#8230;else 首先来说很难看，而且很难维护，每次增加一段处理都需要修改 Router 的代码，显然是违背了 <em>OCP</em> 原则。所以 Router 这里的实现是通过一个 router.php 的配置定义 <code>正则 =&gt; Controller</code> 的映射。在 Router 里来处理这一堆的配置规则。这样，至少我们在增加 Controller 的时候，不用再去修改 Router 的代码了。</p>

<p>APF 其他的处理基本上也是按照 run() 里的方式来组织的（Page 和 Component 就这么被跳过了么&#8230;）。</p>

<h3>2.2 <a href="http://git.corp.anjuke.com/site/system-ext">system-ext</a></h3>

<p>抛开 DAO，关于 system-ext 相比 system 最大的不同在哪？我个人觉得是 <a href="http://git.corp.anjuke.com/site/system-ext/browse/master/classes/apf/proxy/Proxy.php"><em>Apf_Proxy_Proxy.php</em></a> 这个东西。这个类就是代理模式最直接的实现，当然我们也可以拿它来做装饰器模式的事情，只不过配置写起来麻烦点。</p>

<p>代理模式有什么用？如果你知道 AOP(Aspect Oriented Programming) 是个什么东西，如果里用过 Java，用过 SpringFramework，知道声明式事务是怎么回事，就知道 <strong>代理</strong> 这玩意有多么好用了</p>

<p>想想原来，我们要在一段代码上增加缓存是怎么做的？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nv">$data</span> <span class="o">=</span> <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data</span><span class="p">){</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">getFromDB</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$cache</span><span class="o">-&gt;</span><span class="na">put</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span><span class="nv">$data</span><span class="p">,</span><span class="nv">$time</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>每次增加一段缓存，我们都要写类似上面这样的代码。还有我们性能监控加的断点。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="nx">Anjuke_Performance</span><span class="o">::</span><span class="na">get_instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">benchmark_begin</span><span class="p">(</span><span class="s2">&quot;formatPropData&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$prop</span> <span class="o">=</span> <span class="nx">Props_Data</span><span class="o">::</span><span class="na">formatPropData</span><span class="p">(</span><span class="nv">$propInfo</span><span class="p">);</span>
</span><span class='line'><span class="nx">Anjuke_Performance</span><span class="o">::</span><span class="na">get_instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">benchmark_end</span><span class="p">(</span><span class="s2">&quot;formatPropData&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>每个次加断点我们都要在代码里到处加上这种代码（真没人觉得难看么&#8230;）。好了，现在我们有了 proxy，要加个缓存怎么弄？完全不用修改原来的代码，只需要加一行配置。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'><span class="c1">// servicecache.php</span>
</span><span class='line'><span class="nv">$config</span><span class="p">[</span><span class="s1">&#39;allow_methodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;Anjuke_Core_Service_DemoService::getCurrentTime&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;cachetime&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置里定义的类上的方法就会自动的添加 cache 了，不用再写任何额外的代码。这样做的好处是，业务代码只需要专心处理业务就好了，缓存相关的逻辑是在其他的地方，所以可以比较容易的满足 SRP 原则。我们加缓存或者去掉缓存就只需要修改配置，而不用再去改我们的代码，所以 OCP 也满足了。</p>

<p>类似的，我们需要记录方法处理的时间，也只需要写一个对应的 Proxy, 然后在套在上面就可以处理。不用再满地的去些 benchmark_begin 和 benchmark_end 的代码了。需要去掉也很方便。</p>

<h2>3. 一点点私货</h2>

<p>主要是对代码的一点分类，完全是我个人总结，也有可能通篇都是错的，所以大家看看就好</p>

<p>个人觉得一个项目里的代码可以分为三种</p>

<ul>
<li>控制代码</li>
<li>业务代码</li>
<li>组装代码</li>
</ul>


<p>业务代码就是处理具体业务的代码；控制代码就是定义一段处理流程，将多个业务代码的逻辑组合起来；组装代码就是根据配置把业务代码和控制代码组合在一起的代码，比如各种 Factory/IoC 容器（Spring）。</p>

<p>我认为，好的代码设计，这三者的界限是非常清晰的。比如 APF，前面说的 <code>prepare()</code> 就是一段组装代码。run() 里面就是控制代码，定义了一套流程，业务代码就是 Router、Controller、Interceptor（Page 又被忽略了&#8230;） 。APF 里通过 <code>load_controller()</code>、<code>load_interceptor()</code> 的组装代码来组合业务和控制代码。通过这三者的结合一起来完成了一次请求的处理。</p>

<p>再进一步，实际上一段业务代码内部，也可以分为控制代码、业务代码、组装代码三个部分，这样反复的嵌套，就构成了我们整个项目。</p>

<p>做到这三部分代码的分离，可以比较清晰的写出比较容易维护，可扩展性高的代码。</p>

<p>不过绝大多数情况下，我们其实不需要一开始就分离的这么细，以免前期设计的时间过长，但是最后实际写代码的时候还是发现不能满足需求。也不需要把每一块代码都这么来分离，那样写得要累死了。</p>

<p>所以重构就在这里派上用场了。这里再推荐一本书，<a href="http://www.amazon.cn/%E9%87%8D%E6%9E%84-%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1-%E7%A6%8F%E5%8B%92/dp/B003BY6PLK/">重构:改善既有代码的设计</a></p>

<p>后面我会再写一篇文档，结合我们实际的业务开发的例子，讲一下怎么来写比较容易维护，可扩展性高的代码。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/13/rvm-tutorial/">RVM Tutorial</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-13T11:30:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>RVM是Ruby Version Manager的缩写，是管理Ruby版本的工具，方便在开发、部署的时候于多个Ruby环境中切换与使用</p>

<p>关于RVM的信息，请参考<a href="https://rvm.io">官方网站</a>的最新资料为准</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/05/13/rvm-tutorial/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/13/a-brief-introduction-to-ssh/">A Brief Introduction to SSH</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-13T10:53:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>为什么会有这篇介绍？</h2>

<p>不少人对ssh有疑问或者不明白，典型的例子是在gitcorp/github上添加了公钥后发现无法clone或者push仓库里的代码。</p>

<h2>前言</h2>

<p>ssh是个很大的话题，会发现牵涉到unix-like下很多东西，这里只谈谈我们日常工作中接触最多的那部分</p>

<p>哦，对了，这里的ssh不是Java里的SSH（Spring/Structs/Hibernate）。我也是前几天刚明白XDD</p>

<h2>参考资料</h2>

<ul>
<li><a href="http://www.eng.cam.ac.uk/help/jpmg/ssh/ssh-detail.html">ssh - how it works</a></li>
<li><a href="http://en.wikipedia.org/wiki/Secure_Shell">Secure Shell</a></li>
<li><a href="http://www.unixwiz.net/techtips/ssh-agent-forwarding.html">An Illustrated Guide to SSH Agent Forwarding</a></li>
</ul>


</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/05/13/a-brief-introduction-to-ssh/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/beautiful-computer-programming/">Beautiful Computer Programming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-09T20:49:00+08:00" pubdate data-updated="true">Apr 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>We have seen that computer programming is an art, because it applies accumulated knowledge to the world, because it requires skill and ingenuity, and especially because it produces objects of beauty. A programmer who subconsciously views himself as an artist will enjoy what he does and will do it better. Therefore we can be glad that people who lecture at computer conferences speak about the state of the Art.</p></blockquote>

<p><a href="http://www.paulgraham.com/knuth.html">Computer Programming as an Art</a>。</p>

<h2>美</h2>

<p>毫无疑问，如果计算机程序作为艺术品首先要美。美包括多个方面，程序运行时呈现的界面要漂亮；文档要美观；很重要的，代码本身也要看着舒服。</p>

<p>对于工程师来说，我们接触最多的是代码本身。当我们看书法作品时，首先看到的是整篇文字，这里面的排版，字体的大小，间隔的分布都将影响到整个作品的美观程度。然后才是一个个具体的字。</p>

<p>那么代码也是首先需要有合理的排版，与文本的文字一样，</p>

<ul>
<li><strong>需要有的合理顺序</strong><br/>
能够顺序阅读的代码是最舒服的</li>
<li><strong>段落之间要留有适当空白</strong></li>
<li><strong>指令之间以适当的空格分割</strong></li>
<li><strong>正确的缩进</strong></li>
<li><strong>一行代码不应该太宽</strong><br/>
如果超出屏幕的显示宽度，肯定影响了阅读体验。折行的显示也损害了代码的美观度，尤其是在需要打印输出的情况下。</li>
</ul>


<p>在计算机程序中，我们会对各种标示符进行命名，例如变量名、函数名、类名等等。对这些标示符的命名，应当采用<strong>简单明确</strong>的原则。能否看到名称就能够知道其意图是一个很好的衡量方式。同时也应当避免过度冗长的名称，因为这样既显得无意义，也降低了代码的美观度。</p>

<p>另外，拼写错误的名称将极大影响代码的美观。</p>

<p>优秀的代码应该能够清晰地表达自己的意图，这样的代码能够自我解释，不需要有冗余的注释。对一些特别的实现，代码本身难以表达的，才加上注释。</p>

<p>计算机程序最终呈现出来的界面也要美观。这里包括了与用户交互的界面(UI)；与其他程序交互的编程接口(API)。</p>

<hr />

<p>美观的代码对工程师是一个基础要求。</p>

<p>要写出美的程序，工程师必须是一个爱美的人。可以看他的开发工具是不是很美，编辑器里的字体是否漂亮，色彩搭配很美。很难想象一个用着糟糕字体编辑器的工程师能够写出美的代码。</p>

<h2>酷</h2>

<p>酷是创造性的东西，是很特别的，与众不同的。酷的程序往往来自于创新，采用了一个与传统方式不同，却非常有效的方法解决了问题。</p>

<p>你的程序如果真的很酷，很快就会有各种模仿者。</p>

<hr />

<p>具有激情，乐于尝试新东西的工程师才能够做出酷的东西来。这样的工程师，总觉得目前的实现不够好，还能够更好，并努力尝试新的方法。</p>

<h2>优雅</h2>

<p>对于一个功能，计算机程序可以采用多种方式实现，虽然他们的结果可能一致，但是实现方式确可能有好有坏。这可以表现在程序执行的性能、需要占用的资源等方面，甚至代码的行数。一个排序方法，使用不同的算法，性能的差异可以是天差地别。优雅的代码应该采用简单合理的数据结构、算法和设计模式。</p>

<p>优雅很大程度上体现在对计算机程序的设计上，尤其是在需要多个程序相互协同工作的系统设计时，优雅的设计和糟糕的设计将有很大的区别。</p>

<p>其实优雅的代码和设计对人也是友好的。能够让阅读代码的人感到愉悦，充分理解代码的意图。</p>

<hr />

<p>做出优雅设计的工程师必须拥有丰富的编程经验。在经历了非常多的代码和设计之后，善于总结和学习的工程师逐渐掌握了方法，能够在优雅的设计和糟糕的设计之间做出正确的选择。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/28/perl-prime-in-action-jvm-monitoring-2/">Perl入门实战：JVM监控脚本（下）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-28T15:28:00+08:00" pubdate data-updated="true">Mar 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>套接字</h2>

<p>使用套接字（Socket）进行网络通信的基本流程是：</p>

<ul>
<li>服务端：监听端口、等待连接、接收请求、发送应答；</li>
<li>客户端：连接服务端、发送请求、接收应答。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">use</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$server</span> <span class="o">=</span> <span class="nn">IO::Socket::</span><span class="n">INET</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
</span><span class='line'>    <span class="n">LocalPort</span> <span class="o">=&gt;</span> <span class="mi">10060</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Type</span> <span class="o">=&gt;</span> <span class="n">SOCK_STREAM</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Reuse</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Listen</span> <span class="o">=&gt;</span> <span class="n">SOMAXCONN</span>
</span><span class='line'><span class="p">)</span> <span class="o">||</span> <span class="nb">die</span> <span class="s">&quot;服务创建失败\n&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nv">$server</span><span class="o">-&gt;</span><span class="nb">accept</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$line</span> <span class="o">=</span> <span class="sr">&lt;$client&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">chomp</span><span class="p">(</span><span class="nv">$line</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$line</span> <span class="o">=~</span><span class="sr"> /^JVMPORT ([0-9]+)$/</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;RECV $1\n&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">print</span> <span class="nv">$client</span> <span class="s">&quot;OK\n&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;ERROR $line\n&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">print</span> <span class="nv">$client</span> <span class="s">&quot;ERROR\n&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">close</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">close</span><span class="p">(</span><span class="nv">$server</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/03/28/perl-prime-in-action-jvm-monitoring-2/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/27/fork-and-zombie-process/">Fork()与僵尸进程</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-27T20:18:00+08:00" pubdate data-updated="true">Mar 27<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>使用fork()函数派生出多个子进程来并行执行程序的不同代码块，是一种常用的编程泛型。特别是在网络编程中，父进程初始化后派生出指定数量的子进程，共同监听网络端口并处理请求，从而达到扩容的目的。</p>

<p>但是，在使用fork()函数时若处理不当，很容易产生僵尸进程。根据UNIX系统的定义，僵尸进程是指子进程退出后，它的父进程没有“等待”该子进程，这样的子进程就会成为僵尸进程。何谓“等待”？僵尸进程的危害是什么？以及要如何避免？这就是本文将要阐述的内容。</p>

<h2>fork()函数</h2>

<p>下面这段C语言代码展示了fork()函数的使用方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// myfork.c</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 主进程</span>
</span><span class='line'>            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 子进程</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;fork error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/03/27/fork-and-zombie-process/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/26/perl-prime-in-action-jvm-monitoring-1/">Perl入门实战：JVM监控脚本（上）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-26T23:00:00+08:00" pubdate data-updated="true">Mar 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>由于最近在搭建Zabbix监控服务，需要制作各类监控的模板，如iostat、Nginx、MySQL等，因此会写一些脚本来完成数据采集的工作。又因为近期对Perl语言比较感兴趣，因此决定花些时间学一学，写一个脚本来练练手，于是就有了这样一份笔记。</p>

<h2>需求描述</h2>

<p>我们将编写一个获取JVM虚拟机状态信息的脚本：</p>

<ol>
<li>启动一个服务进程，通过套接字接收形如“JVMPORT 2181”的请求；</li>
<li>执行<code>netstat</code>命令，根据端口获取进程号；</li>
<li>执行<code>jstat</code>命令获取JVM的GC信息；<code>jstack</code>获取线程信息；<code>ps -o pcpu,rss</code>获取CPU和内存使用情况；</li>
<li>将以上信息返回给客户端；</li>
</ol>


<p>之所以需要这样一个服务是因为Zabbix Agent会运行在zabbix用户下，无法获取运行在其他用户下的JVM信息。</p>

<p>此外，Zabbix Agent也需要编写一个脚本来调用上述服务，这个在文章末尾会给出范例代码。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/03/26/perl-prime-in-action-jvm-monitoring-1/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/07/currying-and-partial-application/">柯里化与偏应用（JavaScript描述）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-07T20:59:00+08:00" pubdate data-updated="true">Mar 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>原文：<a href="http://raganwald.com/2013/03/07/currying-and-partial-application.html">http://raganwald.com/2013/03/07/currying-and-partial-application.html</a></p>

<p>上周末我参加了<a href="http://wrocloverb.com/">wroc_love.rb大会</a>，其间<a href="http://steveklabnik.com/">Steve Klabnik</a>的一张PPT中提到了<a href="https://en.wikipedia.org/wiki/Partial_application">偏应用（Partial Application）</a>和<a href="https://en.wikipedia.org/wiki/Currying">柯里化（Currying）</a>，并说这两者之间的区别如今已经不重要了。但是我不这么认为。</p>

<p>在这周发布的博文中，我用五种方式对<code>this</code>和闭包做了解释，但只有三到四种提到了柯里化。所以这篇博文就重点来谈谈这个。</p>

<h2>函数参数的个数</h2>

<p>在讲解之前，我们先明确一些术语。函数定义时会写明它所接收的参数个数（Arity）。“一元函数”（Unary）接收一个参数，“多元函数”（Polyadic）接收多个参数。还有一些特殊的名称，如“二元函数”（Binary）接收两个参数，“三元函数”（Ternary）接收三个参数等。你可以对照希腊语或拉丁语词汇来创造这些特殊的名称。</p>

<p>有些函数能够接收不定数量的参数，我们称之为“可变参数函数”（Variadic）。不过这类函数、以及不接收参数的函数并不是本文讨论的重点。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/03/07/currying-and-partial-application/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/01/using-pypi-provided-by-anjuke/">使用安居客提供的PyPI镜像</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-01T10:52:00+08:00" pubdate data-updated="true">Mar 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>主要提示：安居客现在拥有了自己的PyPI镜像，直接使用http://pypi.corp.anjuke.com/simple ，就可以节省重复去公网下载模块的流量与时间。</p>

<h2>Welcome to the Python World!</h2>

<p>这篇文章的目标读者是还刚接触Python以及安居客将要使用Python的各位开发者，强烈建议把文中提到的延伸信息都阅读一下，百利无害。</p>

<p>使用Python开发程序是一件轻松惬意的事情，它的第三方模块分发机制让开发者能够很方便快速的发布自己的代码、安装部署使用其他开发者做的模块。（详细请参考<a href="http://docs.python.org/2/install/index.html">安装Python模块</a>，<a href="http://docs.python.org/2/distutils/index.html">发布Python模块</a>）</p>

<p>关于Python打包的方式以及开源软加架构里打包的背景信息，可以阅读<a href="http://www.ituring.com.cn/article/19090">这篇内容</a>了解更多。</p>

<h2>如何安装第三方的Python模块</h2>

<p>标准的Python模块源码包里都会带上一个<code>setup.py</code>，它是Python的模块分发机制中的一部分，其中会定义模块的基本信息以及 <strong>依赖</strong> ，后者就是我们重点需要关注的问题。</p>

<p>通常我们只需要执行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python setup.py install</span></code></pre></td></tr></table></div></figure>


<p>即可完成安装。</p>

<h2>Python模块的分发</h2>

<p>传统模块的分发如果采用原始的人肉方式那就显得不够好了；所以Python社区有了PyPI（Python Package Index），官方的地址是<a href="https://pypi.python.org">pypi.python.org</a>，全世界各地还有几个<a href="http://www.pypi-mirrors.org">镜像</a>；以及配套使用的客户端程序，<code>setuptools</code>和<code>pip</code></p>

<p><strong>我们建议使用<code>pip</code></strong></p>

<p>前者一般在Python安装的时候随同一起分发，后者需要手工安装（<code>pythonbrew</code>里则是会自动一起安装）</p>

<p>对于想要使用的模块依赖，使用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>easy_install foobar
</span><span class='line'>
</span><span class='line'>#或者
</span><span class='line'>pip install foobar</span></code></pre></td></tr></table></div></figure>


<p>它的过程就像是ubuntu下的<code>apt-get</code>，自动从配置的镜像（默认是官方）自动查找目标模块，下载，（编译）安装，整个过程轻松简单。</p>

<h2>为什么我们要提供安居客的镜像</h2>

<p>出于安居客未来架构发展的需要，我们在开发、生产环境的部署将会更多的采用自动化；项目的依赖是其中一个不可忽视的环节。对于Python来说，快速高效地安装依赖能提高效率，减少错误。</p>

<p>还有一点是，每次安装都从官方下载会造成流量和时间的浪费；更多的，因为某些大家都懂的原因造成一个项目依赖无法安装，很令人恼火。做镜像提高速度，减少问题也是让工程师快乐的一个体现。</p>

<h2>如何使用安居客的PyPI镜像</h2>

<p><strong>更详细的使用方法请参考<code>easy_install</code>和<code>pip</code>的文档</strong></p>

<h3>安装 (install)</h3>

<ul>
<li>easy_install</li>
</ul>


<p>直接使用easy_install的命令，带上参数指定</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>easy_install -i http://pypi.corp.anjuke.com/simple FOOBAR</span></code></pre></td></tr></table></div></figure>


<p>或者写配置文件<code>~/.pydistutils.cfg</code>，内容如下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[easy_install]
</span><span class='line'>index_url = http://pypi.corp.anjuke.com/simple</span></code></pre></td></tr></table></div></figure>


<ul>
<li>pip</li>
</ul>


<p>直接使用pip命令，带上参数</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pip -i http://pypi.corp.anjuke.com/simple install FOOBAR</span></code></pre></td></tr></table></div></figure>


<p>或者写配置文件<code>~/.pip/pip.conf</code>，内容如下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[global]
</span><span class='line'>index-url = http://pypi.corp.anjuke.com/simple</span></code></pre></td></tr></table></div></figure>


<h3>搜索 (search)</h3>

<p><strong>暂未支持</strong></p>

<h2>最后</h2>

<p>我们希望为工程师、开发者提供更好的环境来支持开发工作。</p>

<p>如果大家在使用中有各种问题，意见和建议，欢迎联系我们。</p>

<p>Happy Hacking ;)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/09/cia-hadoop/">Clojure实战(4)：编写Hadoop MapReduce脚本</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-09T16:43:00+08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Hadoop简介</h2>

<p>众所周知，我们已经进入了大数据时代，每天都有PB级的数据需要处理、分析，从中提取出有用的信息。Hadoop就是这一时代背景下的产物。它是Apache基金会下的开源项目，受<a href="http://en.wikipedia.org/wiki/Apache_Hadoop#Papers">Google两篇论文</a>的启发，采用分布式的文件系统HDFS，以及通用的MapReduce解决方案，能够在数千台物理节点上进行分布式并行计算。</p>

<p>对于Hadoop的介绍这里不再赘述，读者可以<a href="http://hadoop.apache.org/">访问其官网</a>，或阅读<a href="http://product.dangdang.com/main/product.aspx?product_id=21127813">Hadoop权威指南</a>。</p>

<p>Hadoop项目是由Java语言编写的，运行在JVM之上，因此我们可以直接使用Clojure来编写MapReduce脚本，这也是本文的主题。Hadoop集群的搭建不在本文讨论范围内，而且运行MapReduce脚本也无需搭建测试环境。</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/02/09/cia-hadoop/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/13/v2-and-desigin-pattern/">V2 中的软件设计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/13/rvm-tutorial/">RVM Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/13/a-brief-introduction-to-ssh/">A Brief Introduction to SSH</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/09/beautiful-computer-programming/">Beautiful Computer Programming</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/28/perl-prime-in-action-jvm-monitoring-2/">Perl入门实战：JVM监控脚本（下）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/27/fork-and-zombie-process/">fork()与僵尸进程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/26/perl-prime-in-action-jvm-monitoring-1/">Perl入门实战：JVM监控脚本（上）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/07/currying-and-partial-application/">柯里化与偏应用（JavaScript描述）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/01/using-pypi-provided-by-anjuke/">使用安居客提供的PyPI镜像</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/09/cia-hadoop/">Clojure实战(4)：编写Hadoop MapReduce脚本</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/anjuke">@anjuke</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'anjuke',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Anjuke Inc. -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'archcorp';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
