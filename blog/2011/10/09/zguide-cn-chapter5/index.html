
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ZMQ 指南 - 第五章 高级发布-订阅模式 - Anjuke Engineering</title>
  <meta name="author" content="Anjuke Inc.">

  
  <meta name="description" content="作者: Pieter Hintjens &#x70;&#104;&#x40;&#105;&#109;&#x61;&#116;&#105;&#x78;&#x2e;&#99;&#x6f;&#x6d;, CEO iMatix Corporation.
翻译: 张吉 &#106;&#x69;&#x7a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://arch.corp.anjuke.com/blog/2011/10/09/zguide-cn-chapter5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Anjuke Engineering" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38932031-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Anjuke Engineering</a></h1>
  
    <h2>技术成就梦想</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:arch.corp.anjuke.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://github.com/anjuke">Code</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">ZMQ 指南 - 第五章 高级发布-订阅模式</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-09T22:22:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>作者: Pieter Hintjens <a href="&#109;&#x61;&#x69;&#108;&#x74;&#x6f;&#58;&#112;&#x68;&#x40;&#105;&#109;&#x61;&#x74;&#x69;&#x78;&#46;&#99;&#111;&#x6d;">&#x70;&#104;&#x40;&#105;&#109;&#x61;&#116;&#105;&#x78;&#x2e;&#99;&#x6f;&#x6d;</a>, CEO iMatix Corporation.</strong>
<strong>翻译: 张吉 <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#x6f;&#58;&#x6a;&#x69;&#x7a;&#x68;&#97;&#110;&#103;&#64;&#97;&#110;&#x6a;&#x75;&#107;&#x65;&#46;&#99;&#111;&#109;">&#106;&#x69;&#x7a;&#x68;&#x61;&#110;&#103;&#x40;&#x61;&#x6e;&#x6a;&#117;&#107;&#x65;&#x2e;&#x63;&#111;&#x6d;</a>, 安居客集团 好租网工程师</strong></p>

<p>第三章和第四章讲述了ZMQ中请求-应答模式的一些高级用法。如果你已经能够彻底理解了，那我要说声恭喜。这一章我们会关注发布-订阅模式，使用上层模式封装，提升ZMQ发布-订阅模式的性能、可靠性、状态同步及安全机制。</p>

<p>本章涉及的内容有：</p>

<ul>
<li>处理慢订阅者（自杀的蜗牛模式）</li>
<li>高速订阅者（黑箱模式）</li>
<li>构建一个共享键值缓存（克隆模式）</li>
</ul>


<!-- more -->


<h3>检测慢订阅者（自杀的蜗牛模式）</h3>

<p>在使用发布-订阅模式的时候，最常见的问题之一是如何处理响应较慢的订阅者。理想状况下，发布者能以全速发送消息给订阅者，但现实中，订阅者会需要对消息做较长时间的处理，或者写得不够好，无法跟上发布者的脚步。</p>

<p>如何处理慢订阅者？最好的方法当然是让订阅者高效起来，不过这需要额外的工作。以下是一些处理慢订阅者的方法：</p>

<ul>
<li><p><strong>在发布者中贮存消息</strong>。这是Gmail的做法，如果过去的几小时里没有阅读邮件的话，它会把邮件保存起来。但在高吞吐量的应用中，发布者堆积消息往往会导致内存溢出，最终崩溃。特别是当同是有多个订阅者时，或者无法用磁盘来做一个缓冲，情况就会变得更为复杂。</p></li>
<li><p><strong>在订阅者中贮存消息</strong>。这种做法要好的多，其实ZMQ默认的行为就是这样的。如果非得有一个人会因为内存溢出而崩溃，那也只会是订阅者，而非发布者，这挺公平的。然而，这种做法只对瞬间消息量很大的应用才合理，订阅者只是一时处理不过来，但最终会赶上进度。但是，这还是没有解决订阅者速度过慢的问题。</p></li>
<li><p><strong>暂停发送消息</strong>。这也是Gmail的做法，当我的邮箱容量超过7.554GB时，新的邮件就会被Gmail拒收或丢弃。这种做法对发布者来说很有益，ZMQ中若设置了阈值（HWM），其默认行为也就是这样的。但是，我们仍不能解决慢订阅者的问题，我们只是让消息变得断断续续而已。</p></li>
<li><p><strong>断开与满订阅者的连接</strong>。这是hotmail的做法，如果连续两周没有登录，它就会断开，这也是为什么我正在使用第十五个hotmail邮箱。不过这种方案在ZMQ里是行不通的，因为对于发布者而言，订阅者是不可见的，无法做相应处理。</p></li>
</ul>


<p>看来没有一种经典的方式可以满足我们的需求，所以我们就要进行创新了。我们可以让订阅者自杀，而不仅仅是断开连接。这就是“自杀的蜗牛”模式。当订阅者发现自身运行得过慢时（对于慢速的定义应该是一个配置项，当达到这个标准时就大声地喊出来吧，让程序员知道），它会哀嚎一声，然后自杀。</p>

<p>订阅者如何检测自身速度过慢呢？一种方式是为消息进行编号，并在发布者端设置阈值。当订阅者发现消息编号不连续时，它就知道事情不对劲了。这里的阈值就是订阅者自杀的值。</p>

<p>这种方案有两个问题：一、如果我们连接的多个发布者，我们要如何为消息进行编号呢？解决方法是为每一个发布者设定一个唯一的编号，作为消息编号的一部分。二、如果订阅者使用ZMQ_SUBSRIBE选项对消息进行了过滤，那么我们精心设计的消息编号机制就毫无用处了。</p>

<p>有些情形不会进行消息的过滤，所以消息编号还是行得通的。不过更为普遍的解决方案是，发布者为消息标注时间戳，当订阅者收到消息时会检测这个时间戳，如果其差别达到某一个值，就发出警报并自杀。</p>

<p>当订阅者有自身的客户端或服务协议，需要保证最大延迟时间时，自杀的蜗牛模式会很合适。撤销一个订阅者也许并不是最周全的方案，但至少不会引发后续的问题。如果订阅者收到了过时的消息，那可能会对数据造成进一步的破坏，而且很难被发现。</p>

<p>以下是自杀的蜗牛模式的最简实现：</p>

<p><strong>suisnail: Suicidal Snail in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  自杀的蜗牛模式</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="cp">#include &quot;czmq.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  该订阅者会连接至发布者，接收所有的消息，</span>
</span><span class='line'><span class="c1">//  运行过程中它会暂停一会儿，模拟复杂的运算过程，</span>
</span><span class='line'><span class="c1">//  当发现收到的消息超过1秒的延迟时，就自杀。</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MAX_ALLOWED_DELAY   1000    </span><span class="c1">//  毫秒</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">subscriber</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  订阅所有消息</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  获取并处理消息</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int64_t</span> <span class="n">clock</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">terms</span> <span class="o">=</span> <span class="n">sscanf</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
</span><span class='line'>        <span class="n">assert</span> <span class="p">(</span><span class="n">terms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">string</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  自杀逻辑</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zclock_time</span> <span class="p">()</span> <span class="o">-</span> <span class="n">clock</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_DELAY</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;E: 订阅者无法跟进, 取消中</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  工作一定时间</span>
</span><span class='line'>        <span class="n">zclock_sleep</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">zstr_send</span> <span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="s">&quot;订阅者中止&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  发布者每毫秒发送一条用时间戳标记的消息</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">publisher</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备发布者</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  发送当前时间（毫秒）给订阅者</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">string</span> <span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span><span class='line'>        <span class="n">sprintf</span> <span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="n">zclock_time</span> <span class="p">());</span>
</span><span class='line'>        <span class="n">zstr_send</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">signal</span> <span class="o">=</span> <span class="n">zstr_recv_nowait</span> <span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">signal</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">zclock_sleep</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>            <span class="c1">//  等待1毫秒</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  下面的代码会启动一个订阅者和一个发布者，当订阅者死亡时停止运行</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">pubpipe</span> <span class="o">=</span> <span class="n">zthread_fork</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subpipe</span> <span class="o">=</span> <span class="n">zthread_fork</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span> <span class="p">(</span><span class="n">zstr_recv</span> <span class="p">(</span><span class="n">subpipe</span><span class="p">));</span>
</span><span class='line'>    <span class="n">zstr_send</span> <span class="p">(</span><span class="n">pubpipe</span><span class="p">,</span> <span class="s">&quot;break&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zclock_sleep</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>几点说明：</p>

<ul>
<li>示例程序中的消息包含了系统当前的时间戳（毫秒）。在现实应用中，你应该使用时间戳作为消息头，并提供消息内容。</li>
<li>示例程序中的发布者和订阅者是同一个进程的两个线程。在现实应用中，他们应该是两个不同的进程。示例中这么做只是为了演示的方便</li>
</ul>


<h3>高速订阅者（黑箱模式）</h3>

<p>发布-订阅模式的一个典型应用场景是大规模分布式数据处理。如要处理从证券市场上收集到的数据，可以在证券交易系统上设置一个发布者，获取价格信息，并发送给一组订阅者。如果我们有很多订阅者，我们可以使用TCP。如果订阅者到达一定的量，那我们就应该使用可靠的广播协议，如pgm。</p>

<p>假设我们的发布者每秒产生10万条100个字节的消息。在剔除了不需要的市场信息后，这个比率还是比较合理的。现在我们需要记录一天的数据（8小时约有250GB），再将其传入一个模拟网络，即一组订阅者。虽然10万条数据对ZMQ来说很容易处理，但我们需要更高的速度。</p>

<p>假设我们有多台机器，一台做发布者，其他的做订阅者。这些机器都是8核的，发布者那台有12核。</p>

<p>在我们开始发布消息时，有两点需要注意：</p>

<ol>
<li>即便只是处理很少的数据，订阅者仍由可能跟不上发布者的速度；</li>
<li>当处理到6M/s的数据量时，发布者和订阅都有可能达到极限。</li>
</ol>


<p>首先，我们需要将订阅者设计为一种多线程的处理程序，这样我们就能在一个线程中读取消息，使用其他线程来处理消息。一般来说，我们对每种消息的处理方式都是不同的。这样一来，订阅者可以对收到的消息进行一次过滤，如根据头信息来判别。当消息满足某些条件，订阅者会将消息交给worker处理。用ZMQ的语言来说，订阅者会将消息转发给worker来处理。</p>

<p>这样一来，订阅者看上去就像是一个队列装置，我们可以用各种方式去连接队列装置和worker。如我们建立单向的通信，每个worker都是相同的，可以使用PUSH和PULL套接字，分发的工作就交给ZMQ吧。这是最简单也是最快速的方式：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_1.png" alt="1" /></p>

<p>订阅者和发布者之间的通信使用TCP或PGM协议，订阅者和worker的通信由于是在同一个进程中完成的，所以使用inproc协议。</p>

<p>下面我们看看如何突破瓶颈。由于订阅者是单线程的，当它的CPU占用率达到100%时，它无法使用其他的核心。单线程程序总是会遇到瓶颈的，不管是2M、6M还是更多。我们需要将工作量分配到不同的线程中去，并发地执行。</p>

<p>很多高性能产品使用的方案是分片，就是将工作量拆分成独立并行的流。如，一半的专题数据由一个流媒体传输，另一半由另一个流媒体传输。我们可以建立更多的流媒体，但如果CPU核心数不变，那就没有必要了。
让我们看看如何将工作量分片为两个流：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_2.png" alt="2" /></p>

<p>要让两个流全速工作，需要这样配置ZMQ：</p>

<ul>
<li>使用两个I/O线程，而不是一个；</li>
<li>使用两个独立的网络接口；</li>
<li>每个I/O线程绑定至一个网络接口；</li>
<li>两个订阅者线程，分别绑定至一个核心；</li>
<li>使用两个SUB套接字；</li>
<li>剩余的核心供worker使用；</li>
<li>worker线程同时绑定至两个订阅者线程的PUSH套接字。</li>
</ul>


<p>创建的线程数量应和CPU核心数一致，如果我们建立的线程数量超过核心数，那其处理速度只会减少。另外，开放多个I/O线程也是没有必要的。</p>

<h3>共享键值缓存（克隆模式）</h3>

<p>发布-订阅模式和无线电广播有些类似，在你收听之前发送的消息你将无从得知，收到消息的多少又会取决于你的接收能力。让人吃惊的是，对于那些追求完美的工程师来说，这种机器恰恰符合他们的需求，且广为传播，成为现实生活中分发消息的最佳机制。想想非死不可、推特、BBS新闻、体育新闻等应用就知道了。</p>

<p>但是，在很多情形下，可靠的发布-订阅模式同样是有价值的。正如我们讨论请求-应答模式一样，我们会根据“故障”来定义“可靠性”，下面几项便是发布-订阅模式中可能发生的故障：</p>

<ul>
<li>订阅者连接太慢，因此没有收到发布者最初发送的消息；</li>
<li>订阅者速度太慢，同样会丢失消息；</li>
<li>订阅者可能会断开，其间的消息也会丢失。</li>
</ul>


<p>还有一些情况我们碰到的比较少，但不是没有：</p>

<ul>
<li>订阅者崩溃、重启，从而丢失了所有已收到的消息；</li>
<li>订阅者处理消息的速度过慢，导致消息在队列中堆砌并溢出；</li>
<li>因网络过载而丢失消息（特别是PGM协议下的连接）；</li>
<li>网速过慢，消息在发布者处溢出，从而崩溃。</li>
</ul>


<p>其实还会有其他出错的情况，只是以上这些在现实应用中是比较典型的。</p>

<p>我们已经有方法解决上面的某些问题了，比如对于慢速订阅者可以使用自杀的蜗牛模式。但是，对于其他的问题，我们最后能有一个可复用的框架来编写可靠的发布-订阅模式。</p>

<p>难点在于，我们并不知道目标应用程序会怎样处理这些数据。它们会进行过滤、只处理一部分消息吗？它们是否会将消息记录起来供日后使用？它们是否会将消息转发给其下的worker进行处理？需要考虑的情况实在太多了，每种情况都有其所谓的可靠性。</p>

<p>所以，我们将问题抽象出来，供多种应用程序使用。这种抽象应用我们称之为共享的键值缓存，它的功能是通过唯一的键名存储二进制数据块。</p>

<p>不要将这个抽象应用和分布式哈希表混淆起来，它是用来解决节点在分布式网络中相连接的问题的；也不要和分布式键值表混淆，它更像是一个NoSQL数据库。我们要建立的应用是将内存中的状态可靠地传递给一组客户端，它要做到的是：</p>

<ul>
<li>客户端可以随时加入网络，并获得服务端当前的状态；</li>
<li>任何客户端都可以改变键值缓存（插入、更新、删除）；</li>
<li>将这种变化以最短的延迟可靠地传达给所有的客户端；</li>
<li>能够处理大量的客户端，成百上千。</li>
</ul>


<p>克隆模式的要点在于客户端会反过来和服务端进行通信，这在简单的发布-订阅模式中并不常见。所以我这里使用“服务端”、“客户端”而不是“发布者”、“订阅者”这两个词。我们会使用发布-订阅模式作为核心消息模式，不过还需要夹杂其他模式。</p>

<h4>分发键值更新事件</h4>

<p>我们会分阶段实施克隆模式。首先，我们看看如何从服务器发送键值更新事件给所有的客户端。我们将第一章中使用的天气服务模型进行改造，以键值对的方式发送信息，并让客户端使用哈希表来保存：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_3.png" alt="3" /></p>

<p>以下是服务端代码：</p>

<p><strong>clonesrv1: Clone server, Model One in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式服务端模型1</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  让我们直接编译，不生成类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和PUB套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zclock_sleep</span> <span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  使用键值对分发消息</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="o">++</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_fmt_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_store</span>   <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已中止</span><span class="se">\n</span><span class="s">已发送 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以下是客户端代码：</p>

<p><strong>clonecli1: Clone client, Model One in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式客户端模型1</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  让我们直接编译，不生成类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和SUB套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">updates</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">updates</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已中断</span><span class="se">\n</span><span class="s">收到 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>几点说明：</p>

<ul>
<li>所有复杂的工作都在kvmsg类中完成了，这个类能够处理键值对类型的消息对象，其实质上是一个ZMQ多帧消息，共有三帧：键（ZMQ字符串）、编号（64位，按字节顺序排列）、二进制体（保存所有附加信息）。</li>
<li>服务端随机生成消息，使用四位数作为键，这样可以模拟大量而不是过量的哈希表（1万个条目）。</li>
<li>服务端绑定套接字后会等待200毫秒，以避免订阅者连接延迟而丢失数据的问题。我们会在后面的模型中解决这一点。</li>
<li>我们使用“发布者”和“订阅者”来命名程序中使用的套接字，这样可以避免和后续模型中的其他套接字发生混淆。</li>
</ul>


<p>以下是kvmsg的代码，已经经过了精简：
<strong>kvsimple: Key-value message class in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*  =====================================================================</span>
</span><span class='line'><span class="cm">    kvsimple - simple key-value message class for example applications</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    ---------------------------------------------------------------------</span>
</span><span class='line'><span class="cm">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</span>
</span><span class='line'><span class="cm">    Copyright other contributors as noted in the AUTHORS file.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This is free software; you can redistribute it and/or modify it under</span>
</span><span class='line'><span class="cm">    the terms of the GNU Lesser General Public License as published by</span>
</span><span class='line'><span class="cm">    the Free Software Foundation; either version 3 of the License, or (at</span>
</span><span class='line'><span class="cm">    your option) any later version.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This software is distributed in the hope that it will be useful, but</span>
</span><span class='line'><span class="cm">    WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
</span><span class='line'><span class="cm">    Lesser General Public License for more details.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    You should have received a copy of the GNU Lesser General Public</span>
</span><span class='line'><span class="cm">    License along with this program. If not, see</span>
</span><span class='line'><span class="cm">    &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'><span class="cm">    =====================================================================</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;kvsimple.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;zlist.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  键是一个短字符串</span>
</span><span class='line'><span class="cp">#define KVMSG_KEY_MAX   255</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  消息被格式化成三帧</span>
</span><span class='line'><span class="c1">//  frame 0: 键（ZMQ字符串）</span>
</span><span class='line'><span class="c1">//  frame 1: 编号（8个字节，按顺序排列）</span>
</span><span class='line'><span class="c1">//  frame 2: 内容（二进制数据块）</span>
</span><span class='line'><span class="cp">#define FRAME_KEY       0</span>
</span><span class='line'><span class="cp">#define FRAME_SEQ       1</span>
</span><span class='line'><span class="cp">#define FRAME_BODY      2</span>
</span><span class='line'><span class="cp">#define KVMSG_FRAMES    3</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  类结构</span>
</span><span class='line'><span class="k">struct</span> <span class="n">_kvmsg</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//  消息中某帧是否存在</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">present</span> <span class="p">[</span><span class="n">KVMSG_FRAMES</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//  对应的ZMQ消息帧</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="n">frame</span> <span class="p">[</span><span class="n">KVMSG_FRAMES</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//  将键转换为C语言字符串</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">key</span> <span class="p">[</span><span class="n">KVMSG_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  构造函数，设置编号</span>
</span><span class='line'>
</span><span class='line'><span class="n">kvmsg_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_new</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">kvmsg_t</span><span class="p">));</span>
</span><span class='line'>    <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  析构函数</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  释放消息中的帧，可供zhash_freefn()函数调用</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_free</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">//  销毁消息中的帧</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>                <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  释放对象本身</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_destroy</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_free</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  从套接字中读取键值消息，返回kvmsg实例</span>
</span><span class='line'>
</span><span class='line'><span class="n">kvmsg_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_recv</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  读取所有帧，出错则销毁对象</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>            <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">zmq_msg_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zmq_recvmsg</span> <span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  验证多帧消息</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rcvmore</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zsockopt_rcvmore</span> <span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rcvmore</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  向套接字发送键值对消息，不检验消息帧的内容</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zmq_msg_t</span> <span class="n">copy</span><span class="p">;</span>
</span><span class='line'>        <span class="n">zmq_msg_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>            <span class="n">zmq_msg_copy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">zmq_sendmsg</span> <span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copy</span><span class="p">,</span>
</span><span class='line'>            <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="n">ZMQ_SNDMORE</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  从消息中获取键值，不存在则返回NULL</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">)</span>
</span><span class='line'>                <span class="n">size</span> <span class="o">=</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">;</span>
</span><span class='line'>            <span class="n">memcpy</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]),</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息的编号</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int64_t</span>
</span><span class='line'><span class="nf">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">assert</span> <span class="p">(</span><span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span> <span class="o">==</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>        <span class="n">byte</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span>  <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">sequence</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息内容，不存在则返回NULL</span>
</span><span class='line'>
</span><span class='line'><span class="n">byte</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息内容的大小</span>
</span><span class='line'>
</span><span class='line'><span class="kt">size_t</span>
</span><span class='line'><span class="nf">kvmsg_size</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息的键</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">key</span><span class="p">));</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">key</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息的编号</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">byte</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span><span class="p">)</span>       <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息内容</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">body</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  使用printf()格式设置消息键</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_fmt_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="n">KVMSG_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  使用springf()格式设置消息内容</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">value</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  若kvmsg结构的键值均存在，则存入哈希表；</span>
</span><span class='line'><span class="c1">//  如果kvmsg结构已没有引用，则自动销毁和释放。</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_store</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">,</span> <span class="n">zhash_t</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">self_p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]</span>
</span><span class='line'>        <span class="o">&amp;&amp;</span>  <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zhash_update</span> <span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zhash_freefn</span> <span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">kvmsg_free</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  将消息内容打印至标准错误输出，用以调试和跟踪</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">kvmsg_size</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">byte</span>  <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">kvmsg_body</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[seq:%&quot;</span> <span class="n">PRId64</span> <span class="s">&quot;]&quot;</span><span class="p">,</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[key:%s]&quot;</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[size:%zd] &quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">char_nbr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">char_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">char_nbr</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">char_nbr</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%02X&quot;</span><span class="p">,</span> <span class="n">body</span> <span class="p">[</span><span class="n">char_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;NULL message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  测试用例</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">kvmsg_test</span> <span class="p">(</span><span class="kt">int</span> <span class="n">verbose</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span>
</span><span class='line'>        <span class="o">*</span><span class="n">kvmsg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; * kvmsg: &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  准备上下文和套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_bind</span> <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;ipc://kvmsg_selftest.ipc&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_connect</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;ipc://kvmsg_selftest.ipc&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  测试简单消息的发送和接受</span>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;body&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  关闭并销毁所有对象</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们会在下文编写一个更为完整的kvmsg类，可以用到现实环境中。</p>

<p>客户端和服务端都会维护一个哈希表，但这个模型需要所有的客户端都比服务端启动得早，而且不能崩溃，这显然不能满足可靠性的要求。</p>

<h4>创建快照</h4>

<p>为了让后续连接的（或从故障中恢复的）客户端能够获取服务器上的状态信息，需要让它在连接时获取一份快照。正如我们将“消息”的概念简化为“已编号的键值对”，我们也可以将“状态”简化为“一个哈希表”。为获取服务端状态，客户端会打开一个REQ套接字进行请求：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_4.png" alt="4" /></p>

<p>我们需要考虑时间的问题，因为生成快照是需要一定时间的，我们需要知道应从哪个更新事件开始更新快照，服务端是不知道何时有更新事件的。一种方法是先开始订阅消息，收到第一个消息之后向服务端请求“将该条更新之前的所有内容发送给”。这样一来，服务器需要为每一次更新保存一份快照，这显然是不现实的。</p>

<p>所以，我们会在客户端用以下方式进行同步：</p>

<ul>
<li><p>客户端开始订阅服务器的更新事件，然后请求一份快照。这样就能保证这份快照是在上一次更新事件之后产生的。</p></li>
<li><p>客户端开始等待服务器的快照，并将更新事件保存在队列中，做法很简单，不要从套接字中读取消息就可以了，ZMQ会自动将这些消息保存起来，这时不应设置阈值（HWM）。</p></li>
<li><p>当客户端获取到快照后，它将再次开始读取更新事件，但是需要丢弃那些早于快照生成时间的事件。如快照生成时包含了200次更新，那客户端会从第201次更新开始读取。</p></li>
<li><p>随后，客户端就会用更新事件去更新自身的状态了。</p></li>
</ul>


<p>这是一个比较简单的模型，因为它用到了ZMQ消息队列的机制。服务端代码如下：</p>

<p><strong>clonesrv2: Clone server, Model Two in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 - 服务端 - 模型2</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  让我们直接编译，不创建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">state_manager</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备套接字和上下文</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:5557&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  开启状态管理器，并等待同步信号</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">updates</span> <span class="o">=</span> <span class="n">zthread_fork</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">state_manager</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span> <span class="p">(</span><span class="n">zstr_recv</span> <span class="p">(</span><span class="n">updates</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  分发键值消息</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="o">++</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_fmt_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">updates</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已中断</span><span class="se">\n</span><span class="s">已发送 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  快照请求方信息</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">;</span>           <span class="c1">//  用于发送快照的ROUTER套接字</span>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span><span class="p">;</span>     <span class="c1">//  请求方的标识</span>
</span><span class='line'><span class="p">}</span> <span class="n">kvroute_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  发送快照中单个键值对</span>
</span><span class='line'><span class="c1">//  使用kvmsg对象作为载体</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvroute_t</span> <span class="o">*</span><span class="n">kvroute</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvroute_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//  先发送接收方标识</span>
</span><span class='line'>    <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
</span><span class='line'>        <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span> <span class="o">+</span> <span class="n">ZFRAME_REUSE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  该线程维护服务端状态，并处理快照请求。</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">state_manager</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zstr_send</span> <span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="s">&quot;READY&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zmq_pollitem_t</span> <span class="n">items</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">//  当前快照版本</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ETERM</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="c1">//  上下文异常</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  等待主线程的更新事件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>            <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  执行快照请求</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="n">zframe_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">identity</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  请求内容在第二帧中</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">))</span>
</span><span class='line'>                <span class="n">free</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;E: 错误的请求，程序中止</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//  发送快照给客户端</span>
</span><span class='line'>            <span class="n">kvroute_t</span> <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">identity</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  逐项发送</span>
</span><span class='line'>            <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_send_single</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routing</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  发送结束标识，内含快照版本号</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;正在发送快照，版本号 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">identity</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以下是客户端代码：</p>

<p><strong>clonecli2: Clone client, Model Two in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// 克隆模式 - 客户端 - 模型2</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  让我们直接编译，不生成类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和SUB套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5557&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  获取快照</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zstr_send</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;已获取快照，版本号=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  完成</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//  应用队列中的更新事件，丢弃过时事件</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sequence</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>几点说明：</p>

<ul>
<li><p>客户端使用两个线程，一个用来生成随机的更新事件，另一个用来管理状态。两者之间使用PAIR套接字通信。可能你会考虑使用SUB套接字，但是“慢连接”的问题会影响到程序运行。PAIR套接字会让两个线程严格同步的。</p></li>
<li><p>我们在updates套接字上设置了阈值（HWM），避免更新服务内存溢出。在inproc协议的连接中，阈值是两端套接字阈值的加和，所以要分别设置。</p></li>
<li><p>客户端比较简单，用C语言编写，大约60行代码。大多数工作都在kvmsg类中完成了，不过总的来说，克隆模式实现起来还是比较简单的。</p></li>
<li><p>我们没有用特别的方式来序列化状态内容。键值对用kvmsg对象表示，保存在一个哈希表中。在不同的时间请求状态时会得到不同的快照。</p></li>
<li><p>我们假设客户端只和一个服务进行通信，而且服务必须是正常运行的。我们暂不考虑如何从服务崩溃的情形中恢复过来。</p></li>
</ul>


<p>现在，这两段程序都还没有真正地工作起来，但已经能够正确地同步状态了。这是一个多种消息模式的混合体：进程内的PAIR、发布-订阅、ROUTER-DEALER等。</p>

<h4>重发键值更新事件</h4>

<p>第二个模型中，键值更新事件都来自于服务器，构成了一个中心化的模型。但是我们需要的是一个能够在客户端进行更新的缓存，并能同步到其他客户端中。这时，服务端只是一个无状态的中间件，带来的好处有：</p>

<ul>
<li>我们不用太过关心服务端的可靠性，因为即使它崩溃了，我们仍能从客户端中获取完整的数据。</li>
<li>我们可以使用键值缓存在动态节点之间分享数据。</li>
</ul>


<p>客户端的键值更新事件会通过PUSH-PULL套接字传达给服务端：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_5.png" alt="5" /></p>

<p>我们为什么不让客户端直接将更新信息发送给其他客户端呢？虽然这样做可以减少延迟，但是就无法为更新事件添加自增的唯一编号了。很多应用程序都需要更新事件以某种方式排序，只有将消息发给服务端，由服务端分发更新消息，才能保证更新事件的顺序。</p>

<p>有了唯一的编号后，客户端还能检测到更多的故障：网络堵塞或队列溢出。如果客户端发现消息输入流有一段空白，它能采取措施。可能你会觉得此时让客户端通知服务端，让它重新发送丢失的信息，可以解决问题。但事实上没有必要这么做。消息流的空挡表示网络状况不好，如果再进行这样的请求，只会让事情变得更糟。所以一般的做法是由客户端发出警告，并停止运行，等到有专人来维护后再继续工作。
我们开始创建在客户端进行状态更新的模型。以下是客户端代码：</p>

<p><strong>clonesrv3: Clone server, Model Three in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 服务端 模型3</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不创建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  快照请求方信息</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">;</span>           <span class="c1">//  ROUTER套接字</span>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span><span class="p">;</span>     <span class="c1">//  请求方标识</span>
</span><span class='line'><span class="p">}</span> <span class="n">kvroute_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:5557&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="s">&quot;tcp://*:5558&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zmq_pollitem_t</span> <span class="n">items</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">collector</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ZMQ_POLL_MSEC</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  执行来自客户端的更新事件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">collector</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>            <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 发布更新事件 %5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  响应快照请求</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="n">zframe_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">identity</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  请求内容在消息的第二帧中</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">))</span>
</span><span class='line'>                <span class="n">free</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;E: 错误的请求，程序中止</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//  发送快照</span>
</span><span class='line'>            <span class="n">kvroute_t</span> <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">identity</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  逐条发送</span>
</span><span class='line'>            <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_send_single</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routing</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  发送结束标识和编号</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 正在发送快照，版本号：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">identity</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已中断</span><span class="se">\n</span><span class="s">已处理 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  发送一条键值对状态给套接字，使用kvmsg对象保存键值对</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvroute_t</span> <span class="o">*</span><span class="n">kvroute</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvroute_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//  Send identity of recipient first</span>
</span><span class='line'>    <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
</span><span class='line'>        <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span> <span class="o">+</span> <span class="n">ZFRAME_REUSE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以下是客户端代码：</p>

<p><strong>clonecli3: Clone client, Model Three in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 - 客户端 - 模型3</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不创建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和SUB套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5557&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUSH</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5558&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  获取状态快照</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zstr_send</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 已收到快照，版本号：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  完成</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">alarm</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zmq_pollitem_t</span> <span class="n">items</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="n">subscriber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">};</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">tickless</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">alarm</span> <span class="o">-</span> <span class="n">zclock_time</span> <span class="p">()));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tickless</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">tickless</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tickless</span> <span class="o">*</span> <span class="n">ZMQ_POLL_MSEC</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="c1">//  上下文被关闭</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  丢弃过时消息，包括心跳</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sequence</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>                <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 收到更新事件：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  创建一个随机的更新事件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zclock_time</span> <span class="p">()</span> <span class="o">&gt;=</span> <span class="n">alarm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_fmt_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
</span><span class='line'>            <span class="n">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">));</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">alarm</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已准备</span><span class="se">\n</span><span class="s">收到 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>几点说明：</p>

<ul>
<li><p>服务端整合为一个线程，负责收集来自客户端的更新事件并转发给其他客户端。它使用PULL套接字获取更新事件，ROUTER套接字处理快照请求，以及PUB套接字发布更新事件。</p></li>
<li><p>客户端会每隔1秒左右发送随机的更新事件给服务端，现实中这一动作由应用程序触发。</p></li>
</ul>


<h4>子树克隆</h4>

<p>现实中的键值缓存会越变越变，而客户端可能只会需要部分缓存。我们可以使用子树的方式来实现：客户端在发送快照请求时告诉服务端它需要的子树，在订阅更新事件事也指明子树。</p>

<p>关于子树的语法有很多，一种是“分层路径”结构，另一种是“主题树”：</p>

<ul>
<li>分层路径：/some/list/of/paths

<ul>
<li>主题树：some.list.of.topics</li>
</ul>
</li>
</ul>


<p>这里我们会使用分层路径结构，以此扩展服务端和客户端，进行子树操作。维护多个子树其实并不太困难，因此我们不在这里演示。</p>

<p>下面是服务端代码，由模型3衍化而来：</p>

<p><strong>clonesrv4: Clone server, Model Four in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 服务端 模型4</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不创建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  快照请求方信息</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">;</span>           <span class="c1">//  ROUTER套接字</span>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span><span class="p">;</span>     <span class="c1">//  请求方标识</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">;</span>          <span class="c1">//  指定的子树</span>
</span><span class='line'><span class="p">}</span> <span class="n">kvroute_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:5557&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="s">&quot;tcp://*:5558&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zmq_pollitem_t</span> <span class="n">items</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">collector</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ZMQ_POLL_MSEC</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  执行来自客户端的更新事件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">collector</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  Interrupted</span>
</span><span class='line'>            <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 发布更新事件 %5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  响应快照请求</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="n">zframe_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">identity</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  Interrupted</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  请求内容在消息的第二帧中</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">free</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>                <span class="n">subtree</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;E: 错误的请求，程序中止</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//  发送快照</span>
</span><span class='line'>            <span class="n">kvroute_t</span> <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">subtree</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  逐条发送</span>
</span><span class='line'>            <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_send_single</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routing</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  发送结束标识和编号</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 正在发送快照，版本号：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">identity</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">subtree</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已中断</span><span class="se">\n</span><span class="s">已处理 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  发送一条键值对状态给套接字，使用kvmsg对象保存键值对</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvroute_t</span> <span class="o">*</span><span class="n">kvroute</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvroute_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">))</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span>  <span class="n">memcmp</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span>
</span><span class='line'>                <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  先发送接收方的标识</span>
</span><span class='line'>        <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
</span><span class='line'>            <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span> <span class="o">+</span> <span class="n">ZFRAME_REUSE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是客户端代码：</p>

<p><strong>clonecli4: Clone client, Model Four in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 - 客户端 - 模型4</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不创建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvsimple.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SUBTREE &quot;/client/&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  准备上下文和SUB套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5557&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsockopt_set_subscribe</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">,</span> <span class="n">SUBTREE</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUSH</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5558&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  获取状态快照</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zstr_sendm</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zstr_send</span>  <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">SUBTREE</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  Interrupted</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 已收到快照，版本号：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>          <span class="c1">//  Done</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">alarm</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zmq_pollitem_t</span> <span class="n">items</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="n">subscriber</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">};</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">tickless</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">alarm</span> <span class="o">-</span> <span class="n">zclock_time</span> <span class="p">()));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">tickless</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">tickless</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tickless</span> <span class="o">*</span> <span class="n">ZMQ_POLL_MSEC</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="c1">//  上下文被关闭</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  丢弃过时消息，包括心跳</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sequence</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>                <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;I: 收到更新事件：%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  创建一个随机的更新事件</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zclock_time</span> <span class="p">()</span> <span class="o">&gt;=</span> <span class="n">alarm</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_fmt_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">SUBTREE</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
</span><span class='line'>            <span class="n">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">));</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">alarm</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; 已准备</span><span class="se">\n</span><span class="s">收到 %d 条消息</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>瞬间值</h4>

<p>瞬间值指的是那些会立刻过期的值。如果你用克隆模式搭建一个类似DNS的服务时，就可以用瞬间值来模拟动态DNS解析了。当节点连接网络，对外发布它的地址，并不断地更新地址。如果节点断开连接，则它的地址也会失效。</p>

<p>瞬间值可以和会话（session）联系起来，当会话结束时，瞬间值也就失效了。克隆模式中，会话是有客户端定义的，并会在客户端断开连接时消亡。</p>

<p>更简单的方法是为每一个瞬间值设定一个过期时间，客户端会不断延长这个时间，当断开连接时这个时间将得不到更新，服务器就会自动将其删除。</p>

<p>我们会用这种简单的方法来实现瞬间值，因为太过复杂的方法可能不值当，它们的差别仅在性能上体现。如果客户端有很多瞬间值，那为每个值设定过期时间是恰当的；如果瞬间值到达一定的量，那最好还是将其和会话相关联，统一进行过期处理。</p>

<p>首先，我们需要设法在键值对消息中加入过期时间。我们可以增加一个消息帧，但这样一来每当我们需要增加消息内容时就需要修改kvmsg类库了，这并不合适。所以，我们一次性增加一个“属性”消息帧，用于添加不同的消息属性。</p>

<p>其次，我们需要设法删除这条数据。目前为止服务端和客户端会盲目地增改哈希表中的数据，我们可以这样定义：当消息的值是空的，则表示删除这个键的数据。</p>

<p>下面是一个更为完整的kvmsg类代码，它实现了“属性”帧，以及一个UUID帧，我们后面会用到。该类还会负责处理值为空的消息，达到删除的目的：</p>

<p><strong>kvmsg: Key-value message class - full in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*  =====================================================================</span>
</span><span class='line'><span class="cm">    kvmsg - key-value message class for example applications</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    ---------------------------------------------------------------------</span>
</span><span class='line'><span class="cm">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</span>
</span><span class='line'><span class="cm">    Copyright other contributors as noted in the AUTHORS file.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This is free software; you can redistribute it and/or modify it under</span>
</span><span class='line'><span class="cm">    the terms of the GNU Lesser General Public License as published by</span>
</span><span class='line'><span class="cm">    the Free Software Foundation; either version 3 of the License, or (at</span>
</span><span class='line'><span class="cm">    your option) any later version.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This software is distributed in the hope that it will be useful, but</span>
</span><span class='line'><span class="cm">    WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
</span><span class='line'><span class="cm">    Lesser General Public License for more details.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    You should have received a copy of the GNU Lesser General Public</span>
</span><span class='line'><span class="cm">    License along with this program. If not, see</span>
</span><span class='line'><span class="cm">    &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'><span class="cm">    =====================================================================</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;kvmsg.h&quot;</span>
</span><span class='line'><span class="cp">#include &lt;uuid/uuid.h&gt;</span>
</span><span class='line'><span class="cp">#include &quot;zlist.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  键是短字符串</span>
</span><span class='line'><span class="cp">#define KVMSG_KEY_MAX   255</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  消息包含五帧</span>
</span><span class='line'><span class="c1">//  frame 0: 键(ZMQ字符串)</span>
</span><span class='line'><span class="c1">//  frame 1: 编号(8个字节，按顺序排列)</span>
</span><span class='line'><span class="c1">//  frame 2: UUID(二进制块，16个字节)</span>
</span><span class='line'><span class="c1">//  frame 3: 属性(ZMQ字符串)</span>
</span><span class='line'><span class="c1">//  frame 4: 值(二进制块)</span>
</span><span class='line'><span class="cp">#define FRAME_KEY       0</span>
</span><span class='line'><span class="cp">#define FRAME_SEQ       1</span>
</span><span class='line'><span class="cp">#define FRAME_UUID      2</span>
</span><span class='line'><span class="cp">#define FRAME_PROPS     3</span>
</span><span class='line'><span class="cp">#define FRAME_BODY      4</span>
</span><span class='line'><span class="cp">#define KVMSG_FRAMES    5</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  类结构</span>
</span><span class='line'><span class="k">struct</span> <span class="n">_kvmsg</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//  帧是否存在</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">present</span> <span class="p">[</span><span class="n">KVMSG_FRAMES</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//  对应消息帧</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="n">frame</span> <span class="p">[</span><span class="n">KVMSG_FRAMES</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//  键，C语言字符串格式</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">key</span> <span class="p">[</span><span class="n">KVMSG_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//  属性列表，key=value形式</span>
</span><span class='line'>    <span class="n">zlist_t</span> <span class="o">*</span><span class="n">props</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">props_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  将属性列表序列化为字符串</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">s_encode_props</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_PROPS</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_PROPS</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">props_size</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_first</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">strcpy</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">prop</span><span class="p">);</span>
</span><span class='line'>        <span class="n">dest</span> <span class="o">+=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_next</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_PROPS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  从字符串中解析属性列表</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">s_decode_props</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_PROPS</span><span class="p">];</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">props_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">zlist_size</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">))</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">zlist_pop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">eoln</span> <span class="o">=</span> <span class="n">memchr</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">remainder</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">eoln</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">*</span><span class="n">eoln</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">zlist_append</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">strdup</span> <span class="p">(</span><span class="n">prop</span><span class="p">));</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">props_size</span> <span class="o">+=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">remainder</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">prop</span> <span class="o">=</span> <span class="n">eoln</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">eoln</span> <span class="o">=</span> <span class="n">memchr</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">remainder</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  构造函数，指定消息编号</span>
</span><span class='line'>
</span><span class='line'><span class="n">kvmsg_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_new</span> <span class="p">(</span><span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">kvmsg_t</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span> <span class="o">=</span> <span class="n">zlist_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  析构函数</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  释放内存函数，供zhash_free_fn()调用</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_free</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">//  释放所有消息帧</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>                <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  释放属性列表</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">zlist_size</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">))</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">zlist_pop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">));</span>
</span><span class='line'>        <span class="n">zlist_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  释放对象本身</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_destroy</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_free</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  复制kvmsg对象</span>
</span><span class='line'>
</span><span class='line'><span class="n">kvmsg_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_dup</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">];</span>
</span><span class='line'>            <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">kvmsg</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">];</span>
</span><span class='line'>            <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="n">src</span><span class="p">));</span>
</span><span class='line'>            <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">dst</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="n">src</span><span class="p">));</span>
</span><span class='line'>            <span class="n">kvmsg</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">kvmsg</span><span class="o">-&gt;</span><span class="n">props</span> <span class="o">=</span> <span class="n">zlist_copy</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">kvmsg</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  从套接字总读取键值对，返回kvmsg实例</span>
</span><span class='line'>
</span><span class='line'><span class="n">kvmsg_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_recv</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  读取所有帧，若有异常则直接返回空</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>            <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">zmq_msg_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zmq_recvmsg</span> <span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  验证多帧消息</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rcvmore</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zsockopt_rcvmore</span> <span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rcvmore</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'>        <span class="n">s_decode_props</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  向套接字发送键值对消息，空消息也发送</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">s_encode_props</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">frame_nbr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span><span class="p">;</span> <span class="n">frame_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zmq_msg_t</span> <span class="n">copy</span><span class="p">;</span>
</span><span class='line'>        <span class="n">zmq_msg_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">])</span>
</span><span class='line'>            <span class="n">zmq_msg_copy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">frame_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">zmq_sendmsg</span> <span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copy</span><span class="p">,</span>
</span><span class='line'>            <span class="p">(</span><span class="n">frame_nbr</span> <span class="o">&lt;</span> <span class="n">KVMSG_FRAMES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="n">ZMQ_SNDMORE</span><span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">copy</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息的键</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">)</span>
</span><span class='line'>                <span class="n">size</span> <span class="o">=</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">;</span>
</span><span class='line'>            <span class="n">memcpy</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]),</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息的编号</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int64_t</span>
</span><span class='line'><span class="nf">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">assert</span> <span class="p">(</span><span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span> <span class="o">==</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>        <span class="n">byte</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">]);</span>
</span><span class='line'>        <span class="kt">int64_t</span> <span class="n">sequence</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span> <span class="p">((</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'>                         <span class="o">+</span>  <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">sequence</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息的UUID</span>
</span><span class='line'>
</span><span class='line'><span class="n">byte</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_uuid</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">]</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span>  <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">])</span> <span class="o">==</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">uuid_t</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息的内容</span>
</span><span class='line'>
</span><span class='line'><span class="n">byte</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  返回消息内容的长度</span>
</span><span class='line'>
</span><span class='line'><span class="kt">size_t</span>
</span><span class='line'><span class="nf">kvmsg_size</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">zmq_msg_size</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息的键</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">key</span><span class="p">));</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">key</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息的编号</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">byte</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>    <span class="n">source</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">((</span><span class="n">sequence</span><span class="p">)</span>       <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_SEQ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  生成并设置消息的UUID</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_uuid</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">];</span>
</span><span class='line'>    <span class="n">uuid_t</span> <span class="n">uuid</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uuid_generate</span> <span class="p">(</span><span class="n">uuid</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">uuid</span><span class="p">));</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">uuid</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">uuid</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_UUID</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息的内容</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmq_msg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span>
</span><span class='line'>        <span class="n">zmq_msg_close</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zmq_msg_init_size</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="n">memcpy</span> <span class="p">(</span><span class="n">zmq_msg_data</span> <span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">body</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  使用printf()格式设置消息的键</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_fmt_key</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="n">KVMSG_KEY_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">KVMSG_KEY_MAX</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  使用printf()格式设置消息内容</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">value</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  获取消息属性，无则返回空字符串</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">strchr</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_first</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">namelen</span>
</span><span class='line'>        <span class="o">&amp;&amp;</span>  <span class="n">memcmp</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="o">&amp;&amp;</span>  <span class="n">prop</span> <span class="p">[</span><span class="n">namelen</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">prop</span> <span class="o">+</span> <span class="n">namelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_next</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置消息属性</span>
</span><span class='line'><span class="c1">//  属性名称不能包含=号，值的最大长度是255</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">strchr</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="mi">255</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_start</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vsnprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="n">va_end</span> <span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  分配空间</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">malloc</span> <span class="p">(</span><span class="n">strlen</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  删除已存在的属性</span>
</span><span class='line'>    <span class="n">sprintf</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;%s=&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">existing</span> <span class="o">=</span> <span class="n">zlist_first</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">existing</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">props_size</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="n">zlist_remove</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">existing</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">existing</span><span class="p">);</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">existing</span> <span class="o">=</span> <span class="n">zlist_next</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//  添加新属性</span>
</span><span class='line'>    <span class="n">strcat</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zlist_append</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">,</span> <span class="n">prop</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">props_size</span> <span class="o">+=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  在哈希表中保存kvmsg对象</span>
</span><span class='line'><span class="c1">//  当kvmsg对象不再被使用时进行释放操作；</span>
</span><span class='line'><span class="c1">//  若传入的值为空，则删除该对象。</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_store</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">,</span> <span class="n">zhash_t</span> <span class="o">*</span><span class="n">hash</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">self_p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_size</span> <span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_KEY</span><span class="p">]</span>
</span><span class='line'>            <span class="o">&amp;&amp;</span>  <span class="n">self</span><span class="o">-&gt;</span><span class="n">present</span> <span class="p">[</span><span class="n">FRAME_BODY</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">zhash_update</span> <span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>                <span class="n">zhash_freefn</span> <span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">kvmsg_free</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">zhash_delete</span> <span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  将消息内容输出到标准错误输出</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">kvmsg_size</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">byte</span>  <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">kvmsg_body</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[seq:%&quot;</span> <span class="n">PRId64</span> <span class="s">&quot;]&quot;</span><span class="p">,</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[key:%s]&quot;</span><span class="p">,</span> <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">self</span><span class="p">));</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[size:%zd] &quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">zlist_size</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_first</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>            <span class="k">while</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s;&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">);</span>
</span><span class='line'>                <span class="n">prop</span> <span class="o">=</span> <span class="n">zlist_next</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">char_nbr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">char_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">char_nbr</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">char_nbr</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%02X&quot;</span><span class="p">,</span> <span class="n">body</span> <span class="p">[</span><span class="n">char_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;NULL message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  测试用例</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">kvmsg_test</span> <span class="p">(</span><span class="kt">int</span> <span class="n">verbose</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span>
</span><span class='line'>        <span class="o">*</span><span class="n">kvmsg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot; * kvmsg: &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  准备上下文和套接字</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_bind</span> <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s">&quot;ipc://kvmsg_selftest.ipc&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_connect</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;ipc://kvmsg_selftest.ipc&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  测试简单消息的收发</span>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_uuid</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;body&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 测试带有属性的消息的收发</span>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;prop1&quot;</span><span class="p">,</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;prop2&quot;</span><span class="p">,</span> <span class="s">&quot;value1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;prop2&quot;</span><span class="p">,</span> <span class="s">&quot;value2&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_uuid</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;body&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;prop2&quot;</span><span class="p">),</span> <span class="s">&quot;value2&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
</span><span class='line'>        <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;prop2&quot;</span><span class="p">),</span> <span class="s">&quot;value2&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  关闭并销毁所有对象</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端模型5和模型4没有太大区别，只是kvmsg类库变了。在更新消息的时候还需要添加一个过期时间的属性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">30</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>服务端模型5有较大的变化，我们会用反应堆来代替轮询，这样就能混合处理定时事件和套接字事件了，只是在C语言中是比较麻烦的。下面是代码：</p>

<p><strong>clonesrv5: Clone server, Model Five in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 - 服务端 - 模型5</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不建类库</span>
</span><span class='line'><span class="cp">#include &quot;kvmsg.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  反应堆处理器</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_snapshots</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_collector</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_flush_ttl</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  服务器属性</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>                <span class="c1">//  上下文</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span><span class="p">;</span>             <span class="c1">//  键值对存储</span>
</span><span class='line'>    <span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">;</span>              <span class="c1">//  zloop反应堆</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>                   <span class="c1">//  主端口</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">;</span>           <span class="c1">//  更新事件编号</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span><span class="p">;</span>             <span class="c1">//  处理快照请求</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span><span class="p">;</span>            <span class="c1">//  发布更新事件</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span><span class="p">;</span>            <span class="c1">//  从客户端收集接收更新事件</span>
</span><span class='line'><span class="p">}</span> <span class="n">clonesrv_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">clonesrv_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">5556</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span> <span class="o">=</span> <span class="n">zloop_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">zloop_set_verbose</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  打开克隆模式服务端套接字</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">snapshot</span>  <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">,</span>  <span class="s">&quot;tcp://*:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span><span class="p">,</span> <span class="s">&quot;tcp://*:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  注册反应堆处理程序</span>
</span><span class='line'>    <span class="n">zloop_reader</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">s_snapshots</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zloop_reader</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span><span class="p">,</span> <span class="n">s_collector</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zloop_timer</span>  <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s_flush_ttl</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  运行反应堆，直至中断</span>
</span><span class='line'>    <span class="n">zloop_start</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zloop_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  发送快照内容</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  请求方信息</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">;</span>           <span class="c1">//  ROUTER套接字</span>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span><span class="p">;</span>     <span class="c1">//  请求方标识</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">;</span>          <span class="c1">//  子树信息</span>
</span><span class='line'><span class="p">}</span> <span class="n">kvroute_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_snapshots</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="n">zframe_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  请求位于消息第二帧</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>            <span class="n">subtree</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;E: 错误的请求，程序中止</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">subtree</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//  发送状态快照</span>
</span><span class='line'>            <span class="n">kvroute_t</span> <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">subtree</span> <span class="p">};</span>
</span><span class='line'>            <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_send_single</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routing</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  发送结束符和版本号</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发送快照，版本号：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">identity</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">subtree</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  每次发送一个快照键值对</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvroute_t</span> <span class="o">*</span><span class="n">kvroute</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvroute_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">))</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span>  <span class="n">memcmp</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span>
</span><span class='line'>                <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  先发送接收方标识</span>
</span><span class='line'>        <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
</span><span class='line'>            <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span> <span class="o">+</span> <span class="n">ZFRAME_REUSE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  收集更新事件</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_collector</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">collector</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
</span><span class='line'>            <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="n">ttl</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发布更新事件 %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  删除过期的瞬间值</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_flush_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_flush_ttl</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_flush_single</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  删除过期的键值对，并广播该事件</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_flush_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">ttl</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sscanf</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">),</span> <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttl</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&amp;&amp;</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">&gt;=</span> <span class="n">ttl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 发布删除事件 %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>克隆服务器的可靠性</h4>

<p>克隆模型1至5相对比较简单，下面我们会探讨一个非常复杂的模型。可以发现，为了构建可靠的消息队列，我们需要花费非常多的精力。所以我们经常会问：有必要这么做吗？如果说你能够接受可靠性不够高的、或者说已经足够好的架构，那恭喜你，你在成本和收益之间找到了平衡。虽然我们会偶尔丢失一些消息，但从经济的角度来说还是合理的。不管怎样，下面我们就来介绍这个复杂的模型。</p>

<p>在模型3中，你会关闭和重启服务，这会导致数据的丢失。任何后续加入的客户端只能得到重启之后的那些数据，而非所有的。下面就让我们想办法让克隆模式能够承担服务器重启的故障。</p>

<p>以下列举我们需要处理的问题：</p>

<ul>
<li><p>克隆服务器进程崩溃并自动或手工重启。进程丢失了所有数据，所以必须从别处进行恢复。</p></li>
<li><p>克隆服务器硬件故障，长时间不能恢复。客户端需要切换至另一个可用的服务端。</p></li>
<li><p>克隆服务器从网络上断开，如交换机发生故障等。它会在某个时点重连，但期间的数据就需要替代的服务器负责处理。</p></li>
</ul>


<p>第一步我们需要增加一个服务器。我们可以使用第四章中提到的双子星模式，它是一个反应堆，而我们的程序经过整理后也是一个反应堆，因此可以互相协作。</p>

<p>我们需要保证更新事件在主服务器崩溃时仍能保留，最简单的机制就是同时发送给两台服务器。</p>

<p>备机就可以当做一台客户端来运行，像其他客户端一样从主机获取更新事件。同时它又能从客户端获取更新事件——虽然不应该以此更新数据，但可以先暂存起来。</p>

<p>所以，相较于模型5，模型6中引入了以下特性：</p>

<ul>
<li><p>客户端发送更新事件改用PUB-SUB套接字，而非PUSH-PULL。原因是PUSH套接字会在没有接收方时阻塞，且会进行负载均衡——我们需要两台服务器都接收到消息。我们会在服务器端绑定SUB套接字，在客户端连接PUB套接字。</p></li>
<li><p>我们在服务器发送给客户端的更新事件中加入心跳，这样客户端可以知道主机是否已死，然后切换至备机。</p></li>
<li><p>我们使用双子星模式的bstar反应堆类来创建主机和备机。双子星模式中需要有一个“投票”套接字，来协助判定对方节点是否已死。这里我们使用快照请求来作为“投票”。</p></li>
<li><p>我们将为所有的更新事件添加UUID属性，它由客户端生成，服务端会将其发布给所有客户端。</p></li>
<li><p>备机将维护一个“待处理列表”，保存来自客户端、尚未由服务端发布的更新事件；或者反过来，来自服务端、尚未从客户端收到的更新事件。这个列表从旧到新排列，这样就能方便地从顶部删除消息。</p></li>
</ul>


<p>我们可以为客户端设计一个有限状态机，它有三种状态：</p>

<ul>
<li><p>客户端打开并连接了套接字，然后向服务端发送快照请求。为了避免消息风暴，它只会请求两次。</p></li>
<li><p>客户端等待快照应答，如果获得了则保存它；如果没有获得，则向第二个服务器发送请求。</p></li>
<li><p>客户端收到快照，便开始等待更新事件。如果在一定时间内没有收到服务端响应，则会连接第二个服务端。</p></li>
</ul>


<p>客户端会一直循环下去，可能在程序刚启动时，部分客户端会试图连接主机，部分连接备机，相信双子星模式会很好地处理这一情况的。</p>

<p>我们可以将客户端状态图绘制出来：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_6.png" alt="6" /></p>

<p>故障恢复的步骤如下：
  * 客户端检测到主机不再发送心跳，因此转而连接备机，并请求一份新的快照；
  * 备机开始接收快照请求，并检测到主机死亡，于是开始作为主机运行；
  * 备机将待处理列表中的更新事件写入自身状态中，然后开始处理快照请求。</p>

<p>当主机恢复连接时：
  * 启动为slave状态，并作为克隆模式客户端连接备机；
  * 同时，使用SUB套接字从客户端接收更新事件。</p>

<p>我们做两点假设：
  * 至少有一台主机会继续运行。如果两台主机都崩溃了，那我们将丢失所有的服务端数据，无法恢复。
  * 不同的客户端不会同时更新同一个键值对。客户端的更新事件会先后到达两个服务器，因此更新的顺序可能会不一致。单个客户端的更新事件到达两台服务器的顺序是相同的，所以不用担心。</p>

<p>下面是整体架构图：</p>

<p><img src="https://github.com/anjuke/zguide-cn/raw/master/images/chapter5_7.png" alt="7" /></p>

<p>开始编程之前，我们需要将客户端重构成一个可复用的类。在ZMQ中写异步类有时是为了练习如何写出优雅的代码，但这里我们确实是希望克隆模式可以成为一种易于使用的程序。上述架构的伸缩性来源于客户端的正确行为，因此有必要将其封装成一份API。要在客户端中进行故障恢复还是比较复杂的，试想一下自由者模式和克隆模式结合起来会是什么样的吧。</p>

<p>按照我的习惯，我会先写出一份API的列表，然后加以实现。让我们假想一个名为clone的API，在其基础之上编写克隆模式客户端API。将代码封装为API显然会提升代码的稳定性，就以模型5为例，客户端需要打开三个套接字，端点名称直接写在了代码里。我们可以创建这样一组API：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//  为每个套接字指定端点</span>
</span><span class='line'><span class="n">clone_subscribe</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">clone_snapshot</span>  <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5557&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">clone_updates</span>   <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5558&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  由于有两个服务端，因此再执行一次</span>
</span><span class='line'><span class="n">clone_subscribe</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5566&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">clone_snapshot</span>  <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5567&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">clone_updates</span>   <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5568&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>但这种写法还是比较啰嗦的，因为没有必要将API内部的一些设计暴露给编程人员。现在我们会使用三个套接字，而将来可能就会使用两个，或者四个。我们不可能让所有的应用程序都相应地修改吧？让我们把这些信息包装到API中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//  指定主备服务器端点</span>
</span><span class='line'><span class="n">clone_connect</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5551&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">clone_connect</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:5561&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样一来代码就变得非常简介，不过也会对现有代码的内部就够造成影响。我们需要从一个端点中推算出三个端点。一种方法是假设客户端和服务端使用三个连续的端点通信，并将这个规则写入协议；另一个方法是向服务器索取缺少的端点信息。我们使用第一种较为简单的方法：</p>

<ul>
<li>服务器状态ROUTER在端点P；</li>
<li>服务器更新事件PUB在端点P + 1；</li>
<li>服务器更新事件SUB在端点P + 2。</li>
</ul>


<p>clone类和第四章的flcliapi类很类似，由两部分组成：</p>

<ul>
<li>一个在后台运行的异步克隆模式代理。该代理处理所有的I/O操作，实时地和服务器进行通信；</li>
<li>一个在前台应用程序中同步运行的clone类。当你创建了一个clone对象后，它会自动创建后台的clone线程；当你销毁clone对象，该后台线程也会被销毁。</li>
</ul>


<p>前台的clone类会使用inproc管道和后台的代理进行通信。C语言中，czmq线程会自动为我们创建这个管道。这也是ZMQ多线程编程的常规方式。</p>

<p>如果没有ZMQ，这种异步的设计将很难处理高压工作，而ZMQ会让其变得简单。编写出来额代码会相对比较复杂。我们可以用反应堆的模式来编写，但这会进一步增加复杂度，且影响应用程序的使用。因此，我们的设计的API将更像是一个能够和服务器进行通信的键值表：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">clone_t</span> <span class="o">*</span><span class="nf">clone_new</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">clone_destroy</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">clone_connect</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">clone_set</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="nf">clone_get</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面就是克隆模式客户端模型6的代码，因为调用了API，所以非常简短：
<strong>clonecli6: Clone client, Model Six in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  克隆模式 - 客户端 - 模型6</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不建类库</span>
</span><span class='line'><span class="cp">#include &quot;clone.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define SUBTREE &quot;/client/&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//  创建分布式哈希表</span>
</span><span class='line'>    <span class="n">clone_t</span> <span class="o">*</span><span class="n">clone</span> <span class="o">=</span> <span class="n">clone_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  配置</span>
</span><span class='line'>    <span class="n">clone_subtree</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">SUBTREE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">clone_connect</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost&quot;</span><span class="p">,</span> <span class="s">&quot;5556&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">clone_connect</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s">&quot;tcp://localhost&quot;</span><span class="p">,</span> <span class="s">&quot;5566&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  插入随机键值</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">zctx_interrupted</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  生成随机值</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">key</span> <span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">value</span> <span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'>        <span class="n">sprintf</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">SUBTREE</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">10000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">sprintf</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">));</span>
</span><span class='line'>        <span class="n">clone_set</span> <span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">randof</span> <span class="p">(</span><span class="mi">30</span><span class="p">));</span>
</span><span class='line'>        <span class="n">sleep</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">clone_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">clone</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以下是clone类的实现：
<strong>clone: Clone class in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*  =====================================================================</span>
</span><span class='line'><span class="cm">    clone - client-side Clone Pattern class</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    ---------------------------------------------------------------------</span>
</span><span class='line'><span class="cm">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</span>
</span><span class='line'><span class="cm">    Copyright other contributors as noted in the AUTHORS file.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This is free software; you can redistribute it and/or modify it under</span>
</span><span class='line'><span class="cm">    the terms of the GNU Lesser General Public License as published by</span>
</span><span class='line'><span class="cm">    the Free Software Foundation; either version 3 of the License, or (at</span>
</span><span class='line'><span class="cm">    your option) any later version.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    This software is distributed in the hope that it will be useful, but</span>
</span><span class='line'><span class="cm">    WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
</span><span class='line'><span class="cm">    Lesser General Public License for more details.</span>
</span><span class='line'>
</span><span class='line'><span class="cm">    You should have received a copy of the GNU Lesser General Public</span>
</span><span class='line'><span class="cm">    License along with this program. If not, see</span>
</span><span class='line'><span class="cm">    &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'><span class="cm">    =====================================================================</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;clone.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  请求超时时间</span>
</span><span class='line'><span class="cp">#define GLOBAL_TIMEOUT  4000    </span><span class="c1">//  msecs</span>
</span><span class='line'><span class="c1">//  判定服务器死亡的时间</span>
</span><span class='line'><span class="cp">#define SERVER_TTL      5000    </span><span class="c1">//  msecs</span>
</span><span class='line'><span class="c1">//  服务器数量</span>
</span><span class='line'><span class="cp">#define SERVER_MAX      2</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  =====================================================================</span>
</span><span class='line'><span class="c1">//  同步部分，在应用程序线程中工作</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  类结构</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">_clone_t</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>                <span class="c1">//  上下文</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>                 <span class="c1">//  和后台代理间的通信套接字</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  该线程用于处理真正的clone类</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">clone_agent</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  构造函数</span>
</span><span class='line'>
</span><span class='line'><span class="n">clone_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">clone_new</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clone_t</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">clone_t</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">zthread_fork</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">clone_agent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  析构函数</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">clone_destroy</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">self_p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  在链接之前指定快照和更新事件的子树</span>
</span><span class='line'><span class="c1">//  发送给后台代理的消息内容为[SUBTREE][subtree]</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">clone_subtree</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">zmsg_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;SUBTREE&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  连接至新的服务器端点</span>
</span><span class='line'><span class="c1">//  消息内容：[CONNECT][endpoint][service]</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">clone_connect</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">zmsg_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  设置新值</span>
</span><span class='line'><span class="c1">//  消息内容：[SET][key][value][ttl]</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">clone_set</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ttl</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">ttlstr</span> <span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'>    <span class="n">sprintf</span> <span class="p">(</span><span class="n">ttlstr</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">zmsg_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;SET&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ttlstr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  取值</span>
</span><span class='line'><span class="c1">//  消息内容：[GET][key]</span>
</span><span class='line'><span class="c1">//  如果没有clone可用，会返回NULL</span>
</span><span class='line'>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span>
</span><span class='line'><span class="nf">clone_get</span> <span class="p">(</span><span class="n">clone_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">zmsg_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_addstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="n">zmsg_recv</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  =====================================================================</span>
</span><span class='line'><span class="c1">//  异步部分，在后台运行</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  单个服务端信息</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">;</span>              <span class="c1">//  服务端地址</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>                   <span class="c1">//  端口</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span><span class="p">;</span>             <span class="c1">//  快照套接字</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span><span class="p">;</span>           <span class="c1">//  接收更新事件的套接字</span>
</span><span class='line'>    <span class="kt">uint64_t</span> <span class="n">expiry</span><span class="p">;</span>            <span class="c1">//  服务器过期时间</span>
</span><span class='line'>    <span class="n">uint</span> <span class="n">requests</span><span class="p">;</span>              <span class="c1">//  收到的快照请求数</span>
</span><span class='line'><span class="p">}</span> <span class="n">server_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">server_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">server_new</span> <span class="p">(</span><span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">server_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">server_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">server_t</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: adding server %s:%d...&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">strdup</span> <span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsockopt_set_subscribe</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">,</span> <span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">server_destroy</span> <span class="p">(</span><span class="n">server_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">server_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">self_p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  后台代理类</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  状态</span>
</span><span class='line'><span class="cp">#define STATE_INITIAL       0   </span><span class="c1">//  连接之前</span>
</span><span class='line'><span class="cp">#define STATE_SYNCING       1   </span><span class="c1">//  正在同步</span>
</span><span class='line'><span class="cp">#define STATE_ACTIVE        2   </span><span class="c1">//  正在更新</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>                <span class="c1">//  上下文</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>                 <span class="c1">//  与主线程通信的套接字</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span><span class="p">;</span>             <span class="c1">//  键值表</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">;</span>              <span class="c1">//  子树</span>
</span><span class='line'>    <span class="n">server_t</span> <span class="o">*</span><span class="n">server</span> <span class="p">[</span><span class="n">SERVER_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="n">uint</span> <span class="n">nbr_servers</span><span class="p">;</span>           <span class="c1">//  范围：0 - SERVER_MAX</span>
</span><span class='line'>    <span class="n">uint</span> <span class="n">state</span><span class="p">;</span>                 <span class="c1">//  当前状态</span>
</span><span class='line'>    <span class="n">uint</span> <span class="n">cur_server</span><span class="p">;</span>            <span class="c1">//  当前master，0/1</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">;</span>           <span class="c1">//  键值对编号</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span><span class="p">;</span>            <span class="c1">//  发布更新事件的套接字</span>
</span><span class='line'><span class="p">}</span> <span class="n">agent_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">agent_t</span> <span class="o">*</span>
</span><span class='line'><span class="nf">agent_new</span> <span class="p">(</span><span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">agent_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">agent_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">agent_t</span><span class="p">));</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span> <span class="o">=</span> <span class="n">strdup</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_INITIAL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">agent_destroy</span> <span class="p">(</span><span class="n">agent_t</span> <span class="o">**</span><span class="n">self_p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">assert</span> <span class="p">(</span><span class="n">self_p</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">self_p</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">agent_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="n">self_p</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">server_nbr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">server_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">server_nbr</span> <span class="o">&lt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">nbr_servers</span><span class="p">;</span> <span class="n">server_nbr</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>            <span class="n">server_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">server</span> <span class="p">[</span><span class="n">server_nbr</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="o">*</span><span class="n">self_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  若线程被中断则返回-1</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">agent_control_message</span> <span class="p">(</span><span class="n">agent_t</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">zmsg_t</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">zmsg_recv</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">command</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;SUBTREE&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">service</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">nbr_servers</span> <span class="o">&lt;</span> <span class="n">SERVER_MAX</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">server</span> <span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">nbr_servers</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_new</span> <span class="p">(</span>
</span><span class='line'>                <span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">service</span><span class="p">),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//  广播更新事件</span>
</span><span class='line'>            <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">address</span><span class="p">,</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">service</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;E: too many servers (max. %d)&quot;</span><span class="p">,</span> <span class="n">SERVER_MAX</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">address</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">service</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;SET&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zhash_update</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zhash_freefn</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//  向服务端发送键值对</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_uuid</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_fmt_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">,</span> <span class="n">ttl</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'><span class="n">puts</span> <span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">ttl</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">key</span><span class="p">);</span>             <span class="c1">//  键值对实际由哈希表对象控制</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">zmsg_popstr</span> <span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">zhash_lookup</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>            <span class="n">zstr_send</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">zstr_send</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">free</span> <span class="p">(</span><span class="n">command</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  异步的后台代理会维护一个服务端池，并处理来自应用程序的请求或应答。</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span>
</span><span class='line'><span class="nf">clone_agent</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">agent_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">agent_new</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zmq_pollitem_t</span> <span class="n">poll_set</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">{</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>            <span class="p">{</span> <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span> <span class="n">ZMQ_POLLIN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">poll_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">poll_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>        <span class="n">server_t</span> <span class="o">*</span><span class="n">server</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">server</span> <span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">cur_server</span><span class="p">];</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">STATE_INITIAL</span>:
</span><span class='line'>                <span class="c1">//  该状态下，如果有可用服务，会发送快照请求</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">nbr_servers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在等待服务器 %s:%d...&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">server</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">requests</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">zstr_sendm</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">zstr_send</span>  <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>                        <span class="n">server</span><span class="o">-&gt;</span><span class="n">requests</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="n">server</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="n">SERVER_TTL</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_SYNCING</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">poll_set</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">poll_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">STATE_SYNCING</span>:
</span><span class='line'>                <span class="c1">//  该状态下我们从服务器端接收快照内容，若失败则尝试其他服务器</span>
</span><span class='line'>                <span class="n">poll_set</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">snapshot</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">STATE_ACTIVE</span>:
</span><span class='line'>                <span class="c1">//  该状态下我们从服务器获取更新事件，失败则尝试其他服务器</span>
</span><span class='line'>                <span class="n">poll_set</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">poll_timer</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">-</span> <span class="n">zclock_time</span> <span class="p">())</span>
</span><span class='line'>                       <span class="o">*</span> <span class="n">ZMQ_POLL_MSEC</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">poll_timer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">poll_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  ------------------------------------------------------------</span>
</span><span class='line'>        <span class="c1">//  poll循环</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zmq_poll</span> <span class="p">(</span><span class="n">poll_set</span><span class="p">,</span> <span class="n">poll_size</span><span class="p">,</span> <span class="n">poll_timer</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>              <span class="c1">//  上下文已被关闭</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">poll_set</span> <span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">agent_control_message</span> <span class="p">(</span><span class="n">self</span><span class="p">))</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">poll_set</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">ZMQ_POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">poll_set</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  任何服务端的消息将重置它的过期时间</span>
</span><span class='line'>            <span class="n">server</span><span class="o">-&gt;</span><span class="n">expiry</span> <span class="o">=</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="n">SERVER_TTL</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SYNCING</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//  保存快照内容</span>
</span><span class='line'>                <span class="n">server</span><span class="o">-&gt;</span><span class="n">requests</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_ACTIVE</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: received from %s:%d snapshot=%d&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">server</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
</span><span class='line'>                        <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//  丢弃过期的更新事件</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: received from %s:%d update=%d&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">server</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
</span><span class='line'>                        <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                    <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//  服务端已死，尝试其他服务器</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 服务器 %s:%d 无响应&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">server</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">cur_server</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">cur_server</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">nbr_servers</span><span class="p">;</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_INITIAL</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">agent_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后是克隆服务器的模型6代码：</p>

<p><strong>clonesrv6: Clone server, Model Six in C</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// 克隆模式 - 服务端 - 模型6</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  直接编译，不建类库</span>
</span><span class='line'><span class="cp">#include &quot;bstar.c&quot;</span>
</span><span class='line'><span class="cp">#include &quot;kvmsg.c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  bstar反应堆API</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_snapshots</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_collector</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_flush_ttl</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_hugz</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_new_master</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_new_slave</span>  <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_subscriber</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  服务端属性</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">zctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>                <span class="c1">//  上下文</span>
</span><span class='line'>    <span class="n">zhash_t</span> <span class="o">*</span><span class="n">kvmap</span><span class="p">;</span>             <span class="c1">//  存放键值对</span>
</span><span class='line'>    <span class="n">bstar_t</span> <span class="o">*</span><span class="n">bstar</span><span class="p">;</span>             <span class="c1">//  bstar反应堆核心</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">sequence</span><span class="p">;</span>           <span class="c1">//  更新事件编号</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>                   <span class="c1">//  主端口</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">peer</span><span class="p">;</span>                   <span class="c1">//  同伴端口</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">publisher</span><span class="p">;</span>            <span class="c1">//  发布更新事件的端口</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span><span class="p">;</span>            <span class="c1">//  接收客户端更新事件的端口</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span><span class="p">;</span>           <span class="c1">//  接受同伴更新事件的端口</span>
</span><span class='line'>    <span class="n">zlist_t</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>           <span class="c1">//  延迟的更新事件</span>
</span><span class='line'>    <span class="n">Bool</span> <span class="n">primary</span><span class="p">;</span>               <span class="c1">//  是否为主机</span>
</span><span class='line'>    <span class="n">Bool</span> <span class="n">master</span><span class="p">;</span>                <span class="c1">//  是否为master</span>
</span><span class='line'>    <span class="n">Bool</span> <span class="n">slave</span><span class="p">;</span>                 <span class="c1">//  是否为slave</span>
</span><span class='line'><span class="p">}</span> <span class="n">clonesrv_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span> <span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">clonesrv_t</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">streq</span> <span class="p">(</span><span class="n">argv</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-p&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 作为主机master运行，正在等待备机slave连接。&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span> <span class="o">=</span> <span class="n">bstar_new</span> <span class="p">(</span><span class="n">BSTAR_PRIMARY</span><span class="p">,</span> <span class="s">&quot;tcp://*:5003&quot;</span><span class="p">,</span>
</span><span class='line'>                                 <span class="s">&quot;tcp://localhost:5004&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">bstar_voter</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">,</span> <span class="s">&quot;tcp://*:5556&quot;</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">s_snapshots</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">5556</span><span class="p">;</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="mi">5566</span><span class="p">;</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">streq</span> <span class="p">(</span><span class="n">argv</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;-b&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 作为备机slave运行，正在等待主机master连接。&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span> <span class="o">=</span> <span class="n">bstar_new</span> <span class="p">(</span><span class="n">BSTAR_BACKUP</span><span class="p">,</span> <span class="s">&quot;tcp://*:5004&quot;</span><span class="p">,</span>
</span><span class='line'>                                 <span class="s">&quot;tcp://localhost:5003&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">bstar_voter</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">,</span> <span class="s">&quot;tcp://*:5566&quot;</span><span class="p">,</span> <span class="n">ZMQ_ROUTER</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">s_snapshots</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">5566</span><span class="p">;</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="mi">5556</span><span class="p">;</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Usage: clonesrv4 { -p | -b }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//  主机将成为master</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">)</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">zctx_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">zlist_new</span> <span class="p">();</span>
</span><span class='line'>    <span class="n">bstar_set_verbose</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  设置克隆服务端套接字</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">,</span> <span class="s">&quot;tcp://*:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_bind</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span><span class="p">,</span> <span class="s">&quot;tcp://*:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  作为克隆客户端连接同伴</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  注册状态事件处理器</span>
</span><span class='line'>    <span class="n">bstar_new_master</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">,</span> <span class="n">s_new_master</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">bstar_new_slave</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">,</span> <span class="n">s_new_slave</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  注册bstar反应堆其他事件处理器</span>
</span><span class='line'>    <span class="n">zloop_reader</span> <span class="p">(</span><span class="n">bstar_zloop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">collector</span><span class="p">,</span> <span class="n">s_collector</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zloop_timer</span>  <span class="p">(</span><span class="n">bstar_zloop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s_flush_ttl</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zloop_timer</span>  <span class="p">(</span><span class="n">bstar_zloop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">),</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s_send_hugz</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  开启bstar反应堆</span>
</span><span class='line'>    <span class="n">bstar_start</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  中断，终止。</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">zlist_size</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zlist_pop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">zlist_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
</span><span class='line'>    <span class="n">bstar_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">zctx_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  发送快照内容</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  请求方信息</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">socket</span><span class="p">;</span>           <span class="c1">//  ROUTER套接字</span>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span><span class="p">;</span>     <span class="c1">//  请求放标识</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span><span class="p">;</span>          <span class="c1">//  子树</span>
</span><span class='line'><span class="p">}</span> <span class="n">kvroute_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_snapshots</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zframe_t</span> <span class="o">*</span><span class="n">identity</span> <span class="o">=</span> <span class="n">zframe_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  请求在消息的第二帧中</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">char</span> <span class="o">*</span><span class="n">subtree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>            <span class="n">subtree</span> <span class="o">=</span> <span class="n">zstr_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;E: 错误的请求，正在退出……</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">subtree</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//  发送状态快照</span>
</span><span class='line'>            <span class="n">kvroute_t</span> <span class="n">routing</span> <span class="o">=</span> <span class="p">{</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">subtree</span> <span class="p">};</span>
</span><span class='line'>            <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_send_single</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routing</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//  发送终止消息，以及消息编号</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发送快照，版本号：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">identity</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">subtree</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">free</span> <span class="p">(</span><span class="n">subtree</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  每次发送一个快照键值对</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvroute_t</span> <span class="o">*</span><span class="n">kvroute</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvroute_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">))</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span>  <span class="n">memcmp</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">,</span>
</span><span class='line'>                <span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">subtree</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//  先发送接收方的地址</span>
</span><span class='line'>        <span class="n">zframe_send</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
</span><span class='line'>            <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">ZFRAME_MORE</span> <span class="o">+</span> <span class="n">ZFRAME_REUSE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">kvroute</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  从客户端收集更新事件</span>
</span><span class='line'><span class="c1">//  如果我们是master，则将该事件写入kvmap对象；</span>
</span><span class='line'><span class="c1">//  如果我们是slave，则将其写入延迟队列</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_was_pending</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_collector</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">collector</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">collector</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_dump</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">ttl</span> <span class="o">=</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">));</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
</span><span class='line'>                <span class="n">kvmsg_set_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">+</span> <span class="n">ttl</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发布更新事件：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//  如果我们已经从master中获得了该事件，则丢弃该消息</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">s_was_pending</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kvmsg</span><span class="p">))</span>
</span><span class='line'>                <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>                <span class="n">zlist_append</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  如果消息已在延迟队列中，则删除它并返回TRUE</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_was_pending</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">held</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zlist_first</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">held</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span> <span class="p">(</span><span class="n">kvmsg_uuid</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">kvmsg_uuid</span> <span class="p">(</span><span class="n">held</span><span class="p">),</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">uuid_t</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zlist_remove</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">held</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">held</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zlist_next</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  删除带有过期时间的瞬间值</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">s_flush_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_flush_ttl</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zhash_foreach</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">,</span> <span class="n">s_flush_single</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  如果键值对过期，则进行删除操作，并广播该事件</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_flush_single</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int64_t</span> <span class="n">ttl</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sscanf</span> <span class="p">(</span><span class="n">kvmsg_get_prop</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;ttl&quot;</span><span class="p">),</span> <span class="s">&quot;%&quot;</span> <span class="n">PRId64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ttl</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&amp;&amp;</span> <span class="n">zclock_time</span> <span class="p">()</span> <span class="o">&gt;=</span> <span class="n">ttl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发布删除事件：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  发送心跳</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_send_hugz</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_key</span>  <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="s">&quot;HUGZ&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_set_body</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_send</span>     <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>    <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  状态改变事件处理函数</span>
</span><span class='line'><span class="c1">//  我们将转变为master</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//  备机先将延迟列表中的事件更新到自己的快照中，</span>
</span><span class='line'><span class="c1">//  并开始接收客户端发来的快照请求。</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_new_master</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zloop_cancel</span> <span class="p">(</span><span class="n">bstar_zloop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  应用延迟列表中的事件</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">zlist_size</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kvmsg_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zlist_pop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_set_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="o">++</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_send</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">publisher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在发布延迟列表中的更新事件：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  正在切换为slave</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_new_slave</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">zhash_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">self</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">zloop_reader</span> <span class="p">(</span><span class="n">bstar_zloop</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">bstar</span><span class="p">),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">s_subscriber</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  ---------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">//  从同伴主机（master）接收更新事件；</span>
</span><span class='line'><span class="c1">//  接收该类更新事件时，我们一定是slave。</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">s_subscriber</span> <span class="p">(</span><span class="n">zloop_t</span> <span class="o">*</span><span class="n">loop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">subscriber</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">clonesrv_t</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">clonesrv_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//  获取快照，如果需要的话。</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span> <span class="o">=</span> <span class="n">zhash_new</span> <span class="p">();</span>
</span><span class='line'>        <span class="kt">void</span> <span class="o">*</span><span class="n">snapshot</span> <span class="o">=</span> <span class="n">zsocket_new</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ZMQ_DEALER</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zsocket_connect</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;tcp://localhost:%d&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 正在请求快照：tcp://localhost:%d&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zstr_send</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="s">&quot;ICANHAZ?&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  中断</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">streq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;KTHXBAI&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>          <span class="c1">//  完成</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 收到快照，版本号：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="n">zsocket_destroy</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//  查找并删除</span>
</span><span class='line'>    <span class="n">kvmsg_t</span> <span class="o">*</span><span class="n">kvmsg</span> <span class="o">=</span> <span class="n">kvmsg_recv</span> <span class="p">(</span><span class="n">subscriber</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmsg</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strneq</span> <span class="p">(</span><span class="n">kvmsg_key</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">),</span> <span class="s">&quot;HUGZ&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s_was_pending</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kvmsg</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//  如果master的更新事件比客户端的事件早到，则将master的事件存入延迟列表，</span>
</span><span class='line'>            <span class="c1">//  当收到客户端更新事件时会将其从列表中清除。</span>
</span><span class='line'>            <span class="n">zlist_append</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">kvmsg_dup</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//  如果更新事件比kvmap版本高，则应用它</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">kvmsg_sequence</span> <span class="p">(</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kvmsg_store</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">kvmap</span><span class="p">);</span>
</span><span class='line'>            <span class="n">zclock_log</span> <span class="p">(</span><span class="s">&quot;I: 收到更新事件：%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">kvmsg_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">kvmsg</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段程序只有几百行，但还是花了一些时间来进行调通的。这个模型中包含了故障恢复，瞬间值，子树等等。虽然我们前期设计得很完备，但要在多个套接字之间进行调试还是很困难的。以下是我的工作方式：</p>

<ul>
<li><p>由于使用了反应堆（bstar，建立在zloop之上），我们节省了大量的代码，让程序变得简洁明了。整个服务以一个线程运行，因此不会出现跨线程的问题。只需将结构指针（self）传递给所有的处理器即可。此外，使用发应堆后可以让代码更为模块化，易于重用。</p></li>
<li><p>我们逐个模块进行调试，只有某个模块能够正常运行时才会进入下一步。由于使用了四五个套接字，因此调试的工作量是很大的。我直接将调试信息输出到了屏幕上，因为实在没有必要专门开一个调试器来工作。</p></li>
<li><p>因为一直在使用valgrind工具进行测试，因此我能确定程序没有内存泄漏的问题。在C语言中，内存泄漏是我们非常关心的问题，因为没有什么垃圾回收机制可以帮你完成。正确地使用像kvmsg、czmq之类的抽象层可以很好地避免内存泄漏。</p></li>
</ul>


<p>这段程序肯定还会存在一些BUG，部分读者可能会帮助我调试和修复，我在此表示感谢。</p>

<p>测试模型6时，先开启主机和备机，再打开一组客户端，顺序随意。随机地中止某个服务进程，如果程序设计得是正确的，那客户端获得的数据应该都是一致的。</p>

<h4>克隆模式协议</h4>

<p>花费了那么多精力来开发一套可靠的发布-订阅模式机制，我们当然希望将来能够方便地在其基础之上进行扩展。较好的方法是将其编写为一个协议，这样就能让各种语言来实现它了。</p>

<p>我们将其称为“集群化哈希表协议”，这是一个能够跨集群地进行键值哈希表管理，提供了多客户端的通信机制；客户端可以只操作一个子树的数据，包括更新和定义瞬间值。</p>

<ul>
<li>http://rfc.zeromq.org/spec:12</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">erning</span></span>

      








  


<time datetime="2011-10-09T22:22:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/guide/'>guide</a>, <a class='category' href='/blog/categories/zmq/'>zmq</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/10/09/zguide-cn-chapter4/" title="Previous Post: ZMQ 指南 - 第四章 可靠的请求-应答模式">&laquo; ZMQ 指南 - 第四章 可靠的请求-应答模式</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/11/03/hanzi-to-pinyin/" title="Next Post: 汉字转拼音服务规范">汉字转拼音服务规范 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/10/v2-and-desigin-pattern/">V2 中的软件设计</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/13/rvm-tutorial/">RVM Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/13/a-brief-introduction-to-ssh/">A Brief Introduction to SSH</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/09/beautiful-computer-programming/">Beautiful Computer Programming</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/28/perl-prime-in-action-jvm-monitoring-2/">Perl入门实战：JVM监控脚本（下）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/27/fork-and-zombie-process/">fork()与僵尸进程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/26/perl-prime-in-action-jvm-monitoring-1/">Perl入门实战：JVM监控脚本（上）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/07/currying-and-partial-application/">柯里化与偏应用（JavaScript描述）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/01/using-pypi-provided-by-anjuke/">使用安居客提供的PyPI镜像</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/09/cia-hadoop/">Clojure实战(4)：编写Hadoop MapReduce脚本</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/anjuke">@anjuke</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'anjuke',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Anjuke Inc. -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'archcorp';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://arch.corp.anjuke.com/blog/2011/10/09/zguide-cn-chapter5/';
        var disqus_url = 'http://arch.corp.anjuke.com/blog/2011/10/09/zguide-cn-chapter5/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
